<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">



















  
  
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5">







<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="WgCg、Cong.Wang、WangCong、Vue、Webpack、HTML、CSS、JS">
<meta name="keywords" content="FrontEnd、Life">
<meta property="og:type" content="website">
<meta property="og:title" content="WgCg Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="WgCg Blog">
<meta property="og:description" content="WgCg、Cong.Wang、WangCong、Vue、Webpack、HTML、CSS、JS">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="WgCg Blog">
<meta name="twitter:description" content="WgCg、Cong.Wang、WangCong、Vue、Webpack、HTML、CSS、JS">



  <link rel="alternate" href="/atom.xml" title="WgCg Blog" type="application/atom+xml">




  <link rel="canonical" href="http://yoursite.com/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>WgCg Blog</title>
  






  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0f283e802c778d7b81eb39bcc6caac80";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>







  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband">
    </div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WgCg Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Keep Learning and Never Give Up</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签<span class="badge">36</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类<span class="badge">24</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">36</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-schedule">

    
    
    
      
    

    
      
    

    <a href="/schedule/" rel="section"><i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>日程表</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">

    
    
    
      
    

    
      
    

    <a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>站点地图</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/15/渲染函数的观察者与进阶的数据响应系统.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cong.Wang">
      <meta itemprop="description" content="WgCg、Cong.Wang、WangCong、Vue、Webpack、HTML、CSS、JS">
      <meta itemprop="image" content="/uploads/mine/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WgCg Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/15/渲染函数的观察者与进阶的数据响应系统.html" class="post-title-link" itemprop="url">渲染函数的观察者与进阶的数据响应系统</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-15 22:41:37" itemprop="dateCreated datePublished" datetime="2019-04-15T22:41:37+08:00">2019-04-15</time>
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/04/15/渲染函数的观察者与进阶的数据响应系统.html#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/04/15/渲染函数的观察者与进阶的数据响应系统.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/04/15/渲染函数的观察者与进阶的数据响应系统.html" class="leancloud_visitors" data-flag-title="渲染函数的观察者与进阶的数据响应系统">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">0</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">1 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/05/揭开数据响应系统的面纱.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cong.Wang">
      <meta itemprop="description" content="WgCg、Cong.Wang、WangCong、Vue、Webpack、HTML、CSS、JS">
      <meta itemprop="image" content="/uploads/mine/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WgCg Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/05/揭开数据响应系统的面纱.html" class="post-title-link" itemprop="url">揭开数据响应系统的面纱</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-05 17:01:48" itemprop="dateCreated datePublished" datetime="2019-04-05T17:01:48+08:00">2019-04-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-04-15 22:42:25" itemprop="dateModified" datetime="2019-04-15T22:42:25+08:00">2019-04-15</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/" itemprop="url" rel="index"><span itemprop="name">框架</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/Vue/" itemprop="url" rel="index"><span itemprop="name">Vue</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/Vue/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/04/05/揭开数据响应系统的面纱.html#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/04/05/揭开数据响应系统的面纱.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/04/05/揭开数据响应系统的面纱.html" class="leancloud_visitors" data-flag-title="揭开数据响应系统的面纱">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">8.5k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">8 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h2><ol>
<li>优先级关系：props &gt; data &gt; methods：即已经在<code>props</code>中定义的<code>key</code>不允许出现在<code>data</code>与<code>methods</code>中，已经在<code>data</code>中定义的<code>key</code>不允许出现在<code>methods</code>中</li>
<li><code>vm</code>代理了<code>vm._data</code>对象，<code>vm._data</code>对象是通过<code>vm.$options.data()</code>得到的，即访问<code>vm.a</code>等于访问<code>vm._data.a</code>，对应到源码中<code>src/core/instance/state.js</code>中的<code>proxy</code>方法</li>
</ol>
<h2 id="响应式数据处理"><a href="#响应式数据处理" class="headerlink" title="响应式数据处理"></a>响应式数据处理</h2><p>本节主要针对<code>src/core/instance/state.js</code>中的<code>initData</code>方法最后一句<code>observe(data, true)</code>的执行逻辑进行说明</p>
<p><code>observe</code>方法具体的内容如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">observe</span> (<span class="params">value: any, asRootData: ?boolean</span>): <span class="title">Observer</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isObject(value) || value <span class="keyword">instanceof</span> VNode) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> ob: Observer | <span class="keyword">void</span></span><br><span class="line">    <span class="comment">// 如果value上有__ob__属性且是Observer实例，说明该对象已经被观测</span></span><br><span class="line">    <span class="keyword">if</span> (hasOwn(value, <span class="string">'__ob__'</span>) &amp;&amp; value.__ob__ <span class="keyword">instanceof</span> Observer) &#123;</span><br><span class="line">        ob = value.__ob__</span><br><span class="line">    <span class="comment">// shouldObserve控制是否允许观测的开关</span></span><br><span class="line">    <span class="comment">// isServerRendering 判断是否是服务端渲染</span></span><br><span class="line">    <span class="comment">// Array.isArray(value) || isPlainObject(value) 判断是否是数组或纯对象</span></span><br><span class="line">    <span class="comment">// Object.isExtensible(value) 判断是否是可扩展的</span></span><br><span class="line">    <span class="comment">// !value._isVue 判断是否是Vue实例</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        shouldObserve &amp;&amp;</span><br><span class="line">        !isServerRendering() &amp;&amp;</span><br><span class="line">        (<span class="built_in">Array</span>.isArray(value) || isPlainObject(value)) &amp;&amp;</span><br><span class="line">        <span class="built_in">Object</span>.isExtensible(value) &amp;&amp;</span><br><span class="line">        !value._isVue</span><br><span class="line">    ) &#123;</span><br><span class="line">        ob = <span class="keyword">new</span> Observer(value)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (asRootData &amp;&amp; ob) &#123;</span><br><span class="line">        ob.vmCount++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ob</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Observer</code>（观察者类）定义如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    value: any   <span class="comment">// 要观察的对象本身的引用</span></span><br><span class="line">    dep: Dep <span class="comment">// 依赖实例，用于收集依赖，为了使Vue.set和Vue.delete能够监听对象和数组属性的添加和删除等</span></span><br><span class="line">    vmCount: number <span class="comment">// 除非是根数据，即vm.data，其值大于0，否则等于0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span> (value: any) &#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value</span><br><span class="line">        <span class="keyword">this</span>.dep = <span class="keyword">new</span> Dep()</span><br><span class="line">        <span class="keyword">this</span>.vmCount = <span class="number">0</span></span><br><span class="line">        def(value, <span class="string">'__ob__'</span>, <span class="keyword">this</span>)</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hasProto) &#123;</span><br><span class="line">                protoAugment(value, arrayMethods)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                copyAugment(value, arrayMethods, arrayKeys)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.observeArray(value)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.walk(value)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    walk (obj: <span class="built_in">Object</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(obj)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">            defineReactive(obj, keys[i])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    observeArray (items: <span class="built_in">Array</span>&lt;any&gt;) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = items.length; i &lt; l; i++) &#123;</span><br><span class="line">            observe(items[i])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>constructor</code>做的事情：</p>
<ol>
<li>初始化数据：<code>value</code>引用数据对象本身、<code>dep</code>为<code>Dep</code>类的实例（用于<code>Vue.set &amp; Vue.delete</code>实现对象或数组的添加、删除操作）、初始化<code>vmCount</code>的值为0（如果是根数据在<code>observe</code>函数中对<code>vmCount</code>进行了自加1，说明只有根数据即<code>vm.data</code>本身的<code>vmCount</code>会大于0）</li>
<li>往数据对象上添加了<code>__ob__</code>属性，其值为当前<code>Observer</code>实例</li>
<li><p>判断数据对象是否是数组</p>
<p>如果是数组，判断浏览器是否支持<code>__proto__</code>属性</p>
<ul>
<li><p>如果支持，利用原型链，使<code>value.__proto__</code>属性指向<code>arrMethods</code>，<code>arrMethods</code>是用以<code>Array.prototype</code>为原型创建的对象，其对数组的变异方法（即能修改自身值得方法）进行了重写，这样当使用数组的变异方法时，就会查找原型链，查找到<code>arrMethods</code>对象上定义的方法，在这些方法中我们就能进行<strong>依赖收集</strong>与<strong>事件发布</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/observer/index.js</span></span><br><span class="line">protoAugment(value, arrayMethods)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">protoAugment</span> (<span class="params">target, src: Object</span>) </span>&#123;</span><br><span class="line">    target.__proto__ = src</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/core/observer/array.js</span></span><br><span class="line"><span class="keyword">const</span> arrayProto = <span class="built_in">Array</span>.prototype</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> arrayMethods = <span class="built_in">Object</span>.create(arrayProto)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> methodsToPatch = [</span><br><span class="line">    <span class="string">'push'</span>,</span><br><span class="line">    <span class="string">'pop'</span>,</span><br><span class="line">    <span class="string">'shift'</span>,</span><br><span class="line">    <span class="string">'unshift'</span>,</span><br><span class="line">    <span class="string">'splice'</span>,</span><br><span class="line">    <span class="string">'sort'</span>,</span><br><span class="line">    <span class="string">'reverse'</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Intercept mutating methods and emit events</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">methodsToPatch.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">method</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// cache original method</span></span><br><span class="line">    <span class="keyword">const</span> original = arrayProto[method]</span><br><span class="line">    def(arrayMethods, method, <span class="function"><span class="keyword">function</span> <span class="title">mutator</span> (<span class="params">...args</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> result = original.apply(<span class="keyword">this</span>, args)</span><br><span class="line">        <span class="keyword">const</span> ob = <span class="keyword">this</span>.__ob__</span><br><span class="line">        <span class="keyword">let</span> inserted</span><br><span class="line">        <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'push'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'unshift'</span>:</span><br><span class="line">                inserted = args</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'splice'</span>:</span><br><span class="line">                inserted = args.slice(<span class="number">2</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// inserted的值为往数组中添加的元素，其作用是用于确定当前数组的操作为添加操作，当添加一个新的元素后，要确保对新的元素进行了观测，所以当存在inserted时，调用当前数组的`__ob__`对象的observeArray方法</span></span><br><span class="line">        <span class="keyword">if</span> (inserted) ob.observeArray(inserted)</span><br><span class="line">        <span class="comment">// notify change</span></span><br><span class="line">        ob.dep.notify()</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// src/core/observer/index.js Observer.observeArray：该方法的作用是循环数组，对数组中的每一项进行观测</span></span><br><span class="line">    observeArray (items: <span class="built_in">Array</span>&lt;any&gt;) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = items.length; i &lt; l; i++) &#123;</span><br><span class="line">            observe(items[i])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果不支持<code>__proto__</code>方法，则直接把重写的<strong>变异数组</strong>方法添加到数据对象本身上</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/observer/index.js</span></span><br><span class="line"><span class="keyword">const</span> arrayKeys = <span class="built_in">Object</span>.getOwnPropertyNames(arrayMethods)</span><br><span class="line"></span><br><span class="line">copyAugment(value, arrayMethods, arrayKeys)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">copyAugment</span> (<span class="params">target: Object, src: Object, keys: Array&lt;string&gt;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = keys.length; i &lt; l; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> key = keys[i]</span><br><span class="line">        def(target, key, src[key])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果不是数组（即对象），则调用<code>Observer</code>的<code>walk</code>方法，遍历对象上的属性，调用<code>defineReactive</code>方法，对每一个属性进行观测</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">walk (obj: <span class="built_in">Object</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(obj)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">        defineReactive(obj, keys[i])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>defineReactive</code>定义在<code>src/core/observer/index.js</code>中</p>
<figure class="highlight javascript"><figcaption><span>defineReactive</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    obj: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">    key: string,</span></span></span><br><span class="line"><span class="function"><span class="params">    val: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    customSetter?: ?Function,</span></span></span><br><span class="line"><span class="function"><span class="params">    shallow?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> dep = <span class="keyword">new</span> Dep()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取属性的描述信息</span></span><br><span class="line">    <span class="keyword">const</span> property = <span class="built_in">Object</span>.getOwnPropertyDescriptor(obj, key)</span><br><span class="line">    <span class="comment">// 如果该属性是不可配置的，则没必要也无法进行观测，因为要实现观测必须修改属性的`get`和`set`方法</span></span><br><span class="line">    <span class="keyword">if</span> (property &amp;&amp; property.configurable === <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 缓存原来的geeter和setter</span></span><br><span class="line">    <span class="keyword">const</span> getter = property &amp;&amp; property.get</span><br><span class="line">    <span class="keyword">const</span> setter = property &amp;&amp; property.set</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 首先要明确的一点是，如果if中的代码不执行，那么val的值有可能为undefined，则这时候下方的深度观测语句`let childOb = !shallow &amp;&amp; observe(val)`中的val为undefined，即不会进行深度观测</span></span><br><span class="line">    <span class="comment">// !getter &amp;&amp; arguments.length == 2：如果属性本身存在着`getter`函数，在这里是不希望触发用户所写的`getter`函数的，所以当属性本身不存在`getter`函数时，再获取其值，而付出的代价是如果存在`getters`函数不会进行深度观测</span></span><br><span class="line">    <span class="comment">// !getter || setter：如果不加setter的判断，当第一次观测之后且是深度观测之后，属性上有了下方代码添加的`getter`函数，这时候将属性值赋予一个新的对象，则时候对象上有`getter`函数，造成的结果就是不会进行深度观测，这跟之前的深度观测是相违背的，所以加上setter是否存在的判断</span></span><br><span class="line">    <span class="keyword">if</span> ((!getter || setter) &amp;&amp; <span class="built_in">arguments</span>.length === <span class="number">2</span>) &#123;</span><br><span class="line">        val = obj[key]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进行深度观测，可以把shallow看做一个控制深度观测的开关</span></span><br><span class="line">    <span class="keyword">let</span> childOb = !shallow &amp;&amp; observe(val)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 依赖收集&amp;事件发布</span></span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">        enumerable: <span class="literal">true</span>,</span><br><span class="line">        configurable: <span class="literal">true</span>,</span><br><span class="line">        get: <span class="function"><span class="keyword">function</span> <span class="title">reactiveGetter</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 利用闭包，保留对getter的引用，如果存在getter，则调用getter获取其值，否则为val</span></span><br><span class="line">            <span class="keyword">const</span> value = getter ? getter.call(obj) : val</span><br><span class="line">            <span class="comment">// Dep.target为要收集的依赖</span></span><br><span class="line">            <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">                <span class="comment">// 收集依赖</span></span><br><span class="line">                dep.depend()</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果子对象也是观测对象</span></span><br><span class="line">                <span class="keyword">if</span> (childOb) &#123;</span><br><span class="line">                    <span class="comment">// 收集依赖，因为当一个事件依赖一个对象后，则相当于这个事件也依赖于其子对象，因为修改了子对象，其父对象也变了，这样当修改子对象是，才能正确的发布事件</span></span><br><span class="line">                    childOb.dep.depend()</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">                        <span class="comment">// 如果是数组，则递归调用dependArray进行依赖收集</span></span><br><span class="line">                        dependArray(value)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        &#125;,</span><br><span class="line">        set: <span class="function"><span class="keyword">function</span> <span class="title">reactiveSetter</span> (<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">const</span> value = getter ? getter.call(obj) : val</span><br><span class="line">            <span class="comment">// 如果数据没有发生改变，或者之前为NaN改变之后也为NaN（我们都知道NaN !== NaN），则什么都不做</span></span><br><span class="line">            <span class="keyword">if</span> (newVal === value || (newVal !== newVal &amp;&amp; value !== value)) &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// customSetter：允许在非生产环境进行监听时提供一个函数为参数作为拦截，例如不允许修改内置的属性时会提示错误信息</span></span><br><span class="line">            <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; customSetter) &#123;</span><br><span class="line">                customSetter()</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// #7981: for accessor properties without setter</span></span><br><span class="line">            <span class="keyword">if</span> (getter &amp;&amp; !setter) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果本身存在setter，则调用本身提供的setter进行赋值</span></span><br><span class="line">            <span class="keyword">if</span> (setter) &#123;</span><br><span class="line">                setter.call(obj, newVal)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                val = newVal</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 深度观测</span></span><br><span class="line">            childOb = !shallow &amp;&amp; observe(newVal)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 事件发布</span></span><br><span class="line">            dep.notify()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dependArray</span> (<span class="params">value: Array&lt;any&gt;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> e, i = <span class="number">0</span>, l = value.length; i &lt; l; i++) &#123;</span><br><span class="line">        e = value[i]</span><br><span class="line">        e &amp;&amp; e.__ob__ &amp;&amp; e.__ob__.dep.depend()</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(e)) &#123;</span><br><span class="line">            dependArray(e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<p>下一章：<a href="/2019/04/15/渲染函数的观察者与进阶的数据响应系统.html">渲染函数的观察者与进阶的数据响应系统</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/28/Vue的初始化之开篇.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cong.Wang">
      <meta itemprop="description" content="WgCg、Cong.Wang、WangCong、Vue、Webpack、HTML、CSS、JS">
      <meta itemprop="image" content="/uploads/mine/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WgCg Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/28/Vue的初始化之开篇.html" class="post-title-link" itemprop="url">Vue的初始化之开篇</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-28 13:40:28" itemprop="dateCreated datePublished" datetime="2019-03-28T13:40:28+08:00">2019-03-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-04-15 17:10:42" itemprop="dateModified" datetime="2019-04-15T17:10:42+08:00">2019-04-15</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/" itemprop="url" rel="index"><span itemprop="name">框架</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/Vue/" itemprop="url" rel="index"><span itemprop="name">Vue</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/Vue/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/28/Vue的初始化之开篇.html#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/28/Vue的初始化之开篇.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/03/28/Vue的初始化之开篇.html" class="leancloud_visitors" data-flag-title="Vue的初始化之开篇">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">13k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">11 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="用于初始化的最终选项-options"><a href="#用于初始化的最终选项-options" class="headerlink" title="用于初始化的最终选项\$options"></a>用于初始化的最终选项\$options</h1><p>在<a href="/2019/03/21/以一个例子为线索">以一个例子为线索</a>一节中，我们写了一个很简单的例子，这个例子如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">'#app'</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        test: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>我们以这个例子为线索开始了对<code>Vue</code>代码的讲解，我们知道了在实例化<code>Vue</code>实例的时候，<code>Vue.prototype._init</code>方法被第一个执行，这个方法定义在<code>src/core/instance/init.js</code>文件中，在分析<code>_init</code>方法的时候我们遇到了下面的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.$options = mergeOptions(resolveConstructorOptions(vm.constructor), options || &#123;&#125;, vm)</span><br></pre></td></tr></table></figure>
<p>正式因为上面的代码，使得我们花了大篇章来讲其内部实现和运作，也就是<a href="/2019/03/26/Vue选项的规范化">Vue 选项的规范化</a>和<a href="/2019/03/27/Vue选项的合并">Vue 选项的合并</a>这两节所介绍的内容。现在我们已经知道了<code>mergeOptions</code>函数是如何对父子选项进行合并处理的，也知道了它的作用。</p>
<p>我们打开<code>core/util/options.js</code>文件，找到<code>mergeOptions</code>函数，看其最后一句代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> options</span><br></pre></td></tr></table></figure>
<p>这说明<code>mergeOptions</code>函数最终将合并处理后的选项返回，并以该返回值作为<code>vm.$options</code>的值。<code>vm.$options</code>在<code>Vue</code>的官方文档中是可以找到的，它作为实例属性暴露给开发者，那么现在你应该知道<code>vm.$options</code>到底是什么了。并且看文档的时候你应该更能够理解其作用，比如官方文档是这样介绍<code>$options</code>实例属性的：</p>
<blockquote>
<p>用于当前<code>Vue</code>实例的初始化选项。需要在选项中包含自定义属性时会有用处</p>
</blockquote>
<p>并且给了一个例子，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    customOptions: <span class="string">'foo'</span>,</span><br><span class="line">    created: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.$options.customOption)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>上面的例子中，在创建<code>Vue实例</code>的时候传递了一个自定义选项：<code>customOption</code>,在之后的代码中我们可以通过<code>this.$options.customOption</code>进行访问。原理其实就是使用<code>mergeOptions</code>函数对自定义选项进行合并处理，由于没有指定<code>customOption</code>选项的合并策略，所以将会使用默认的策略函数<code>defaultStrat</code>。最终效果就是你初始化的值是什么，得到的就是什么。</p>
<p>另外，<code>Vue</code>也提供了<code>Vue.config.optionMergeStrategies</code>全局配置，用来指定某一个选项的合并策略，常用于指定自定义选项的合并策略，具体请查看<a href="https://cn.vuejs.org/v2/api/index.html#optionMergeStrategies" target="_blank" rel="noopener">optionMergeStrategies 用法</a></p>
<p>现在我们回到正题上，还是拿我们的例子，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">'#app'</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        test: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这个时候<code>mergeOptions</code>函数将会把<code>Vue.options</code>作为父选项，把我们传递的实例选项作为子选项进行合并，合并的结果我们可以通过打印<code>$options</code>属性得知。其实我们前面已经分析过了，<code>el</code>选项将使用默认合并策略合并，最终的值就是字符串<code>#app</code>，而<code>data</code>选项将变成一个函数，且这个函数的执行结果就是合并后的数据，即：<code>{test: 1}</code>。</p>
<p>下面是<code>vm.$options</code>的截图：</p>
<p><img width="500" src="/assets/vue/theory/vm-$options.jpg" title="vm.$options"></p>
<p>我们发现<code>el</code>确实还是原来的值，而<code>data</code>也确实变成了一个函数，并且这个函数就是我们之前遇到过的<code>mergedInstanceDataFn</code>，除此之外我们还能看到其他合并后的选项，其中<code>components</code>、<code>directives</code>、<code>filters</code>以及<code>_base</code>是存在于<code>Vue.options</code>中的，这些是我们所知道的，至于<code>render</code>赫尔<code>staticRenderFns</code>这两个选项是在将模板编译成渲染函数时添加上去的，我们后面会遇到。另外<code>_parentElm</code>和<code>_refElm</code>这两个选项是在为虚拟 DOM 创建组件实例时添加的，我们后面也会降到，这里大家不需要关心，免得失去重点。</p>
<h1 id="渲染函数的作用域代理"><a href="#渲染函数的作用域代理" class="headerlink" title="渲染函数的作用域代理"></a>渲染函数的作用域代理</h1><p><code>_init</code>方法中，经过<code>mergeOptions</code>合并处理选项之后，要执行的是下面这段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* istanbul ignore else */</span></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    initProxy(vm)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    vm._renderProxy = vm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码的目的是在<code>vm</code>上添加<code>_renderProxy</code>属性，在非生产环境下调用<code>initProxy</code>方法添加，而在生产环境下直接赋值为<code>vm</code></p>
<p>接下来我们来看<code>initProxy</code>中的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> initProxy</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    <span class="comment">// 中间代码省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> hasProxy = <span class="keyword">typeof</span> <span class="built_in">Proxy</span> !== <span class="string">'undefined'</span> &amp;&amp; isNative(<span class="built_in">Proxy</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 中间代码省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> hasHandler = &#123;</span><br><span class="line">        has(target, key) &#123;</span><br><span class="line">            <span class="keyword">const</span> has = key <span class="keyword">in</span> target</span><br><span class="line">            <span class="keyword">const</span> isAllowed = allowedGlobals(key) || (<span class="keyword">typeof</span> key === <span class="string">'string'</span> &amp;&amp; key.charAt(<span class="number">0</span>) === <span class="string">'_'</span> &amp;&amp; !(key <span class="keyword">in</span> target.$data))</span><br><span class="line">            <span class="keyword">if</span> (!has &amp;&amp; !isAllowed) &#123;</span><br><span class="line">                <span class="keyword">if</span> (key <span class="keyword">in</span> target.$data) warnReservedPrefix(target, key)</span><br><span class="line">                <span class="keyword">else</span> warnNonPresent(target, key)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> has || !isAllowed</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> getHandler = &#123;</span><br><span class="line">        get(target, key) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> key === <span class="string">'string'</span> &amp;&amp; !(key <span class="keyword">in</span> target)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (key <span class="keyword">in</span> target.$data) warnReservedPrefix(target, key)</span><br><span class="line">                <span class="keyword">else</span> warnNonPresent(target, key)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> target[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    initProxy = <span class="function"><span class="keyword">function</span> <span class="title">initProxy</span>(<span class="params">vm</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (hasProxy) &#123;</span><br><span class="line">            <span class="comment">// determine which proxy handler to use</span></span><br><span class="line">            <span class="keyword">const</span> options = vm.$options</span><br><span class="line">            <span class="keyword">const</span> handlers = options.render &amp;&amp; options.render._withStripped ? getHandler : hasHandler</span><br><span class="line">            vm._renderProxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(vm, handlers)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            vm._renderProxy = vm</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>initProxy方法的主要逻辑是：</p>
<ol>
<li><p>如果宿主环境支持<code>Proxy</code>方法，使用<code>Proxy</code>方法对<code>vm</code>进行代理，并赋值给<code>vm._renderProxy</code></p>
<ol>
<li><p>如果不满足<code>options.render &amp;&amp; options.render._withStripped</code>条件时，拦截器对象为<code>hasHandler</code></p>
<p>  <code>has</code>可以拦截的操作有：</p>
<ul>
<li>属性查询：foo in proxy</li>
<li>继承属性查询：foo in Object.create(proxy)</li>
<li>with检查：with(proxy) { (foo); }</li>
<li><p>Reflect.has()</p>
<p>其中关键点就在于<code>has</code>操作可以拦截<code>with</code>操作，在<code>src/core/instance/render.js</code>文件中，找到<code>Vue.prototype._render</code>方法，里面有这样的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vnode = render.call(vm._renderProxy, vm.$createElement)</span><br></pre></td></tr></table></figure>
<p>在调用<code>render</code>函数的时候，指定了其执行环境为<code>vm._renderProxy</code>，那么<code>render</code>函数长什么样呢？还是以上面的例子为例，我们可以通过打印<code>vm.$options.render</code>查看，它长成这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vm.$options.render = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// render 函数的 this 指向实例的 _renderProxy</span></span><br><span class="line">    <span class="keyword">with</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> _c(<span class="string">'div'</span>, [_v(_s(a))])   <span class="comment">// 在这里访问 a，相当于访问 vm._renderProxy.a</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以知道<code>with</code>中的<code>this</code>被指定为了<code>vm._renderProxy</code>，所以当我们访问<code>a</code>变量时，就相当于访问<code>vm._renderProxy.a</code>，也正是因为如此，当我们在<code>with</code>语句块中调用一些内置的全局对象是，是不希望被代理到<code>vm._renderProxy</code>，这就是为什么<code>hasHandler</code>中有下面这段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> has = key <span class="keyword">in</span> target</span><br><span class="line"><span class="keyword">const</span> isAllowed = allowedGlobals(key) || (<span class="keyword">typeof</span> key === <span class="string">'string'</span> &amp;&amp; key.charAt(<span class="number">0</span>) === <span class="string">'_'</span> &amp;&amp; !(key <span class="keyword">in</span> target.$data))</span><br><span class="line"><span class="keyword">if</span> (!has &amp;&amp; !isAllowed) &#123;</span><br><span class="line">    <span class="keyword">if</span> (key <span class="keyword">in</span> target.$data) warnReservedPrefix(target, key)</span><br><span class="line">    <span class="keyword">else</span> warnNonPresent(target, key)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码的意思是：如果访问的属性不存在于<code>target</code>(也就是<code>vm</code>)且不是全局对象或者以<code>_</code>开头且不在<code>target.$data</code>上时，是允许被访问的，否则不允许被访问，并给予警告</p>
</li>
</ul>
</li>
<li><p>如果满足时，拦截器对象为<code>getHandler</code></p>
<p>  当<code>render</code>方法存在，即我们构造实例的时候是通过<code>render</code>方法进行模板渲染的时候，且<code>render</code>方法的<code>_withStripped</code>属性为<code>true</code>的时候会使用<code>getHandler</code>，<code>vue-loader</code>提供的单文件组件的能力，其实最终就是把<code>template</code>编译成<code>render</code>方法，并且设置<code>render._withStripped</code>为<code>true</code>，在不使用<code>with</code>语句的<code>render</code>方法中，模板内的变量都是通过属性访问操作<code>vm.a</code>的形式访问的，从前文中我们了解到<code>Proxy</code>的<code>has</code>无法拦截属性访问操作，所以这里需要使用<code>Proxy</code>中可以拦截到属性访问的<code>get</code>，同时也省去了<code>has</code>中的全局变量检查（因为全局变量的访问不会被<code>get</code>拦截）</p>
</li>
</ol>
</li>
<li><p>如果宿主环境不支持<code>Proxy</code>方法，则和生成环境一样，<code>vm._renderProxy</code>的值被设置为<code>vm</code></p>
</li>
</ol>
<h1 id="初始化之initLifecycle"><a href="#初始化之initLifecycle" class="headerlink" title="初始化之initLifecycle"></a>初始化之initLifecycle</h1><p><code>_init</code>函数在执行完<code>initProxy</code>之后，执行的就是<code>initLifecycle</code>函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vm._self = vm</span><br><span class="line">initLifecycle(vm)</span><br></pre></td></tr></table></figure>
<p>在<code>initLifecycle</code>函数执行之前，执行了<code>vm.self = vm</code>语句，这句话在<code>Vue</code>实例对象<code>vm</code>上添加了<code>_self</code>属性，指向真实的实例本身。注意<code>vm._self</code>和<code>vm._renderProxy</code>不同，首先在用途上来说寓意是不同的，另外<code>vm._renderProxy</code>有可能是一个代理对象，即<code>Proxy</code>实例。</p>
<figure class="highlight javascript"><figcaption><span>initLifecycle</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initLifecycle</span> (<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 定义 options，它是 vm.$options 的引用，后面的代码使用的都是 options 常量</span></span><br><span class="line">    <span class="keyword">const</span> options = vm.$options</span><br><span class="line"></span><br><span class="line">    <span class="comment">// locate first non-abstract parent (查找第一个非抽象的父组件)</span></span><br><span class="line">    <span class="comment">// 定义 parent，它引用当前实例的父实例</span></span><br><span class="line">    <span class="keyword">let</span> parent = options.parent</span><br><span class="line">    <span class="comment">// 如果当前实例有父组件，且当前实例不是抽象的</span></span><br><span class="line">    <span class="keyword">if</span> (parent &amp;&amp; !options.abstract) &#123;</span><br><span class="line">        <span class="comment">// 使用 while 循环查找第一个非抽象的父组件</span></span><br><span class="line">        <span class="keyword">while</span> (parent.$options.abstract &amp;&amp; parent.$parent) &#123;</span><br><span class="line">            parent = parent.$parent</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 经过上面的 while 循环后，parent 应该是一个非抽象的组件，将它作为当前实例的父级，所以将当前实例 vm 添加到父级的 $children 属性里</span></span><br><span class="line">        parent.$children.push(vm)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置当前实例的 $parent 属性，指向父级</span></span><br><span class="line">    vm.$parent = parent</span><br><span class="line">    <span class="comment">// 设置 $root 属性，有父级就是用父级的 $root，否则 $root 指向自身</span></span><br><span class="line">    vm.$root = parent ? parent.$root : vm</span><br><span class="line"></span><br><span class="line">    vm.$children = []</span><br><span class="line">    vm.$refs = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    vm._watcher = <span class="literal">null</span></span><br><span class="line">    vm._inactive = <span class="literal">null</span></span><br><span class="line">    vm._directInactive = <span class="literal">false</span></span><br><span class="line">    vm._isMounted = <span class="literal">false</span></span><br><span class="line">    vm._isDestroyed = <span class="literal">false</span></span><br><span class="line">    vm._isBeingDestroyed = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>initLifecycle主要做了几件事：</p>
<ol>
<li>将当前实例添加到父实例（第一个非抽象组件）的<code>$children</code>属性里，并设置当前实例的<code>$parent</code>指向父实例<ol>
<li><code>options.parent</code>来源于<code>Vue</code>的自动侦测父级的功能，实际上，当我们构建Vue实例时传入的<code>components</code>选项，内部会先调用<code>Vue.extend</code>方法，创建compoents对应的子类，然后在实例化子类作为子组件，这是<code>options.parent</code>也就是<code>compoents</code>的<code>parent</code>属性会被初始化为当前构造的实例，这个过程都在虚拟DOM的<code>patch</code>算法中进行的，可以查看<code>src/core/vdom/create-component.js</code>中的<code>createComponentInstanceForVnode</code>方法，它在<code>src/core/vdom/create-component.js</code>文件内的<code>componentVNodeHooks</code>钩子对象的<code>init</code>钩子函数内被调用</li>
<li>抽象组件的特点是：一般不渲染真实DOM，例如<code>Vue</code>内置的组件<code>keep-alive</code>、<code>transition</code>等；不会出现在父子关系的路径上，创建组件实例时，通过设置<code>abstract</code>属性为<code>true</code>，可以将其标记为一个抽象组件，例如<code>src/core/components/keep-alive.js</code>文件</li>
</ol>
</li>
<li>设置当前实例的<code>$root</code>属性为父实例的<code>$root</code>，如果不存在则指向zishen</li>
<li>初始化<code>$children</code>属性为空数组，用于存放子组件，初始化<code>$ref</code>属性为空对象，用于存放设置了<code>ref</code>属性的DOM元素</li>
<li>在实例上设置了一系列供内部使用的变量：<code>_watcher</code>、<code>_inactive</code>、<code>_directInactive</code>、<code>_isMounted</code>、<code>_isDestroyed</code>、<code>_isBeingDestroyed</code></li>
</ol>
<h1 id="初始化之initEvents"><a href="#初始化之initEvents" class="headerlink" title="初始化之initEvents"></a>初始化之initEvents</h1><figure class="highlight javascript"><figcaption><span>initEvents</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initEvents</span> (<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  vm._events = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  vm._hasHookEvent = <span class="literal">false</span></span><br><span class="line">  <span class="comment">// init parent attached events</span></span><br><span class="line">  <span class="keyword">const</span> listeners = vm.$options._parentListeners</span><br><span class="line">  <span class="keyword">if</span> (listeners) &#123;</span><br><span class="line">    updateComponentListeners(vm, listeners)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>往实例上增加了<code>_events</code>、<code>_hasHookEvent</code>属性</li>
<li>判断了<code>vm.$options._parentListeners</code>属性（在<code>src/core/vdom/create-component.js</code>文件中的<code>createComponentInstanceForVnode</code>被初始化）是否存在，如果存在调用<code>updateComponentListeners</code>方法</li>
</ol>
<h1 id="初始化之initRender"><a href="#初始化之initRender" class="headerlink" title="初始化之initRender"></a>初始化之initRender</h1><figure class="highlight javascript"><figcaption><span>initRender</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initRender</span> (<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  vm._vnode = <span class="literal">null</span> <span class="comment">// the root of the child tree</span></span><br><span class="line">  vm._staticTrees = <span class="literal">null</span> <span class="comment">// v-once cached trees</span></span><br><span class="line">  <span class="keyword">const</span> options = vm.$options</span><br><span class="line">  <span class="keyword">const</span> parentVnode = vm.$vnode = options._parentVnode <span class="comment">// the placeholder node in parent tree</span></span><br><span class="line">  <span class="keyword">const</span> renderContext = parentVnode &amp;&amp; parentVnode.context</span><br><span class="line">  vm.$slots = resolveSlots(options._renderChildren, renderContext)</span><br><span class="line">  vm.$scopedSlots = emptyObject</span><br><span class="line">  <span class="comment">// bind the createElement fn to this instance</span></span><br><span class="line">  <span class="comment">// so that we get proper render context inside it.</span></span><br><span class="line">  <span class="comment">// args order: tag, data, children, normalizationType, alwaysNormalize</span></span><br><span class="line">  <span class="comment">// internal version is used by render functions compiled from templates</span></span><br><span class="line">  vm._c = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> createElement(vm, a, b, c, d, <span class="literal">false</span>)</span><br><span class="line">  <span class="comment">// normalization is always applied for the public version, used in</span></span><br><span class="line">  <span class="comment">// user-written render functions.</span></span><br><span class="line">  vm.$createElement = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> createElement(vm, a, b, c, d, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// $attrs &amp; $listeners are exposed for easier HOC creation.</span></span><br><span class="line">  <span class="comment">// they need to be reactive so that HOCs using them are always updated</span></span><br><span class="line">  <span class="keyword">const</span> parentData = parentVnode &amp;&amp; parentVnode.data</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    defineReactive(vm, <span class="string">'$attrs'</span>, parentData &amp;&amp; parentData.attrs || emptyObject, () =&gt; &#123;</span><br><span class="line">      !isUpdatingChildComponent &amp;&amp; warn(<span class="string">`$attrs is readonly.`</span>, vm)</span><br><span class="line">    &#125;, <span class="literal">true</span>)</span><br><span class="line">    defineReactive(vm, <span class="string">'$listeners'</span>, options._parentListeners || emptyObject, () =&gt; &#123;</span><br><span class="line">      !isUpdatingChildComponent &amp;&amp; warn(<span class="string">`$listeners is readonly.`</span>, vm)</span><br><span class="line">    &#125;, <span class="literal">true</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    defineReactive(vm, <span class="string">'$attrs'</span>, parentData &amp;&amp; parentData.attrs || emptyObject, <span class="literal">null</span>, <span class="literal">true</span>)</span><br><span class="line">    defineReactive(vm, <span class="string">'$listeners'</span>, options._parentListeners || emptyObject, <span class="literal">null</span>, <span class="literal">true</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>往实例上增加了<code>$vnode</code>、<code>$slots</code>、<code>$scopedSlots</code>属性</li>
<li>往实例上增加了<code>$attrs</code>、<code>$listeners</code>属性，且在非生产环境时处于<code>updateChildComponent</code>函数外（来自于<code>src/core/instance/lifecycle.js</code>）外更改<code>$attrs</code>或<code>$listeners</code>时，给予一个错误提示</li>
</ol>
<h1 id="声明周期钩子的实现方式"><a href="#声明周期钩子的实现方式" class="headerlink" title="声明周期钩子的实现方式"></a>声明周期钩子的实现方式</h1><p>在<code>initRender</code>函数执行完毕后，是这样一段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">callHook(vm, <span class="string">'beforeCreate'</span>)</span><br><span class="line">initInjections(vm) <span class="comment">// resolve injections before data/props</span></span><br><span class="line">initState(vm)</span><br><span class="line">initProvide(vm) <span class="comment">// resolve provide after data/props</span></span><br><span class="line">callHook(vm, <span class="string">'created'</span>)</span><br></pre></td></tr></table></figure>
<ol>
<li><p><code>callHook</code>方法用于调用生命周期钩子函数</p>
 <figure class="highlight javascript"><figcaption><span>callHook</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">callHook</span> (<span class="params">vm: Component, hook: string</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// #7573 disable dep collection when invoking lifecycle hooks</span></span><br><span class="line">    pushTarget()</span><br><span class="line">    <span class="keyword">const</span> handlers = vm.$options[hook]</span><br><span class="line">    <span class="keyword">if</span> (handlers) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, j = handlers.length; i &lt; j; i++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            handlers[i].call(vm)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            handleError(e, vm, <span class="string">`<span class="subst">$&#123;hook&#125;</span> hook`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (vm._hasHookEvent) &#123;</span><br><span class="line">        vm.$emit(<span class="string">'hook:'</span> + hook)</span><br><span class="line">    &#125;</span><br><span class="line">    popTarget()</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p> 这里的<code>pushTarge</code>和<code>popTarget</code>是为了避免在某些生命周期中使用<code>props</code>数据导致收集冗余的依赖。调用钩子方法时，使用<code>call</code>方法指定了其执行上下文，即把<code>this</code>指向为<code>vm</code></p>
<p> <code>vm._hasHookEvent</code>是在<code>initEvents</code>函数中定义的，它的作用是判断是否存在<strong>生命周期钩子的事件侦听器</strong>，初始化值为<code>false</code>代表没有，当组件检测到存在生命周期钩子的事件侦听器时，会将<code>vm._hasHookEvent</code>设置为<code>true</code>，那么什么是<strong>生命周期钩子事件侦听器</strong>呢？</p>
 <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">child</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">hook:beforeCreate</span>=<span class="string">"handleChildBeforeCreate"</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">hook:created</span>=<span class="string">"handleChildCreated"</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">hook:mounted</span>=<span class="string">"handleChildMounted"</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">hook:</span>生命周期钩子</span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure>
<p> 如上代码可以使用<code>hook:</code>加<code>生命周期钩子名称</code>的方式来监听组件相应的生命周期事件。这是<code>Vue</code>官方文档上没有体现的，但你确实可以这么用，不过除非你对<code>Vue</code>非常了解，否则不建议使用。</p>
</li>
<li><p><code>initState</code>函数包括了：<code>initProps</code>、<code>initMethods</code>、<code>initData</code>、<code>initComputed</code>、<code>initWatch</code>，所以当<code>beforeCreated</code>钩子被调用时，所有与<code>props</code>、<code>methods</code>、<code>data</code>、<code>computed</code>以及<code>watch</code>相关的内容都不能使用，当然<code>inject/provide</code>也是不可用的。作为对立面，<code>created</code>钩子恰好是等待<code>initInjections</code>、<code>initState</code>、<code>initProvide</code>执行完毕后才被调用的，所以在<code>created</code>钩子中，是完全能够使用上面提到的内容。但由于此时还没有任何的挂载操作，所以在<code>created</code>中是不能够访问DOM的。</p>
</li>
</ol>
<h1 id="Vue初始化之initState"><a href="#Vue初始化之initState" class="headerlink" title="Vue初始化之initState"></a>Vue初始化之initState</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">callHook(vm, <span class="string">'beforeCreate'</span>)</span><br><span class="line">initInjections(vm) <span class="comment">// resolve injections before data/props</span></span><br><span class="line">initState(vm)</span><br><span class="line">initProvide(vm) <span class="comment">// resolve provide after data/props</span></span><br><span class="line">callHook(vm, <span class="string">'created'</span>)</span><br></pre></td></tr></table></figure>
<p>可以看到在<code>initState</code>函数执行之前，先执行了<code>initInjections</code>函数，也就是说<code>inject</code>选项要更早被初始化，不过由于初始化 <code>inject</code> 选项的时候涉及到 <code>defineReactive</code> 函数，并且调用了 <code>toggleObserving</code> 函数操作了用于控制是否应该转换为响应式属性的状态标识 <code>observerState.shouldConvert</code>，所以我们决定先讲解 <code>initState</code>，之后再来讲解 <code>initInjections</code> 和 <code>initProvide</code>，这才是一个合理的顺序，并且从 <code>Vue</code> 的时间线上来看 <code>inject/provide</code> 选项确实是后来才添加的。</p>
<figure class="highlight javascript"><figcaption><span>initState</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initState</span> (<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  vm._watchers = []</span><br><span class="line">  <span class="keyword">const</span> opts = vm.$options</span><br><span class="line">  <span class="keyword">if</span> (opts.props) initProps(vm, opts.props)</span><br><span class="line">  <span class="keyword">if</span> (opts.methods) initMethods(vm, opts.methods)</span><br><span class="line">  <span class="keyword">if</span> (opts.data) &#123;</span><br><span class="line">    initData(vm)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    observe(vm._data = &#123;&#125;, <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (opts.computed) initComputed(vm, opts.computed)</span><br><span class="line">  <span class="keyword">if</span> (opts.watch &amp;&amp; opts.watch !== nativeWatch) &#123;</span><br><span class="line">    initWatch(vm, opts.watch)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>往实例上添加了<code>_watchers</code>属性，用于存储所有该组件实例的<code>watcher</code>对象</li>
<li>可以看到<code>props</code>的初始化先于<code>data</code>，这就是为什么我们能够使用<code>props</code>来初始化<code>data</code>的原因</li>
</ol>
<p>下一篇：<a href="/2019/04/05/揭开数据响应系统的面纱.html">揭开数据响应系统的面纱</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/27/Vue选项的合并.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cong.Wang">
      <meta itemprop="description" content="WgCg、Cong.Wang、WangCong、Vue、Webpack、HTML、CSS、JS">
      <meta itemprop="image" content="/uploads/mine/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WgCg Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/27/Vue选项的合并.html" class="post-title-link" itemprop="url">Vue选项的合并</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-27 13:35:09" itemprop="dateCreated datePublished" datetime="2019-03-27T13:35:09+08:00">2019-03-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-28 13:46:26" itemprop="dateModified" datetime="2019-03-28T13:46:26+08:00">2019-03-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/" itemprop="url" rel="index"><span itemprop="name">框架</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/Vue/" itemprop="url" rel="index"><span itemprop="name">Vue</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/Vue/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/27/Vue选项的合并.html#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/27/Vue选项的合并.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/03/27/Vue选项的合并.html" class="leancloud_visitors" data-flag-title="Vue选项的合并">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">17k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">15 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一章节我们了解了<code>Vue</code>对选项的规范，接下来才是真正的合并阶段，我们继续看<code>mergeOptions</code>函数的代码，接下来的一段代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> options = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> key</span><br><span class="line"><span class="keyword">for</span> (key <span class="keyword">in</span> parent) &#123;</span><br><span class="line">    mergeField(key)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (key <span class="keyword">in</span> child) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!hasOwn(parent, key)) &#123;</span><br><span class="line">        mergeField(key)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeField</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> strat = strats[key] || defaultStrat</span><br><span class="line">    options[key] = strat(parent[key], child[key], vm, key)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> options</span><br></pre></td></tr></table></figure>
<p>这段代码的作用是，针对不同的选项，例如<code>components、props、data、filters</code>，采取不同的合并策略进行合并，其中<code>strast</code>的声明在本文件顶部进行了声明，初始化为<code>config.optionsMergeStrategies</code>，它的值现在还是一个空对象，在后续的代码中将往上添加各种合并策略函数。如果你要使用自定义合并策略，只需要在<code>Vue.config.optionsMergeStrategies</code>添加与自定义选项同名的函数就行。这就是<code>Vue</code>文档中提过的全局配置：<a href="https://cn.vuejs.org/v2/api/index.html#optionMergeStrategies" target="_blank" rel="noopener">optionMergeStrategies</a></p>
<h1 id="选项-el、propsData-的合并策略"><a href="#选项-el、propsData-的合并策略" class="headerlink" title="选项 el、propsData 的合并策略"></a>选项 el、propsData 的合并策略</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Options with restrictions</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    strats.el = strats.propsData = <span class="function"><span class="keyword">function</span>(<span class="params">parent, child, vm, key</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!vm) &#123;</span><br><span class="line">            warn(<span class="string">`option "<span class="subst">$&#123;key&#125;</span>" can only be used during instance `</span> + <span class="string">'creation with the `new` keyword.'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> defaultStrat(parent, child)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>el、props</code>采用的合并策略是默认的合并策略：</p>
<figure class="highlight javascript"><figcaption><span>默认合并策略</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Default strategy.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> defaultStrat = <span class="function"><span class="keyword">function</span>(<span class="params">parentVal: any, childVal: any</span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> childVal === <span class="literal">undefined</span> ? parentVal : childVal</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认合并策略：如果子选项是 undefined，则使用父选项，否则使用子选项</p>
<p>这里有一点需要注意，那就是对<code>vm</code>是否存在进行判断，如果不存在，在非生产环境会给予错误提示，我们都知道当前这个<code>vm</code>是由<code>mergeOptions</code>中的<code>vm</code>传过来的，而<code>mergeOptions</code>的<code>vm</code>来自于<code>_init</code>方法，<code>_init</code>方法是在<code>Vue</code>构造函数中被调用，所以当我们通过<code>new</code>操作符创建<code>Vue</code>实例时，这个<code>vm</code>是一定存在的。那么说明，在某种情况下，<code>vm</code>可能不存在，也就是<code>mergeOptions</code>方法除了在<code>_init</code>方法被调用，还在其它地方也被调用了。这个地方就是<code>src/core/global-api/extend.js</code>中的<code>Vue.extend</code>方法，其中有这么一段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Sub.options = mergeOptions(Super.options, extendOptions)</span><br></pre></td></tr></table></figure>
<p>可以看到，当我们通过<code>Vue.extend</code>创建子类的时候<code>mergeOptions</code>会被调用，此时策略函数就拿不到第三个参数，所以最终能得到的结论是：<strong>如果策略函数中拿不到<code>vm</code>参数，那么处理的就是子组件选项（调用<code>Vue.extend传入的选项参数</code>）</strong></p>
<h1 id="选项-data-的合并策略"><a href="#选项-data-的合并策略" class="headerlink" title="选项 data 的合并策略"></a>选项 data 的合并策略</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">strats.data = <span class="function"><span class="keyword">function</span>(<span class="params">parentVal: any, childVal: any, vm?: Component</span>): ?<span class="title">Function</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!vm) &#123;</span><br><span class="line">        <span class="keyword">if</span> (childVal &amp;&amp; <span class="keyword">typeof</span> childVal !== <span class="string">'function'</span>) &#123;</span><br><span class="line">            process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warn(<span class="string">'The "data" option should be a function '</span> + <span class="string">'that returns a per-instance value in component '</span> + <span class="string">'definitions.'</span>, vm)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> parentVal</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mergeDataOrFn(parentVal, childVal)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mergeDataOrFn(parentVal, childVal, vm)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果处理的是子组件选项：</p>
<p>如果 data 不存在或 data 不为一个函数，给予错误提示，并返回父 data。我们都知道为了防止不同组件的共享一个 data，所以子组件的 data 选项必须要为一个返回 object 的函数</p>
<p>否则，调用 mergeDataOrFn 方法，传入父 data 选项、子 data 选项</p>
<p>如果处理的不是子组件选项，调用 mergeDataOrFn 方法，传入父 data 选项、子 data 选项、vm</p>
<figure class="highlight javascript"><figcaption><span>mergeDataFn</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Data</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mergeDataOrFn</span>(<span class="params">parentVal: any, childVal: any, vm?: Component</span>): ?<span class="title">Function</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!vm) &#123;</span><br><span class="line">        <span class="comment">// in a Vue.extend merge, both should be functions</span></span><br><span class="line">        <span class="keyword">if</span> (!childVal) &#123;</span><br><span class="line">            <span class="keyword">return</span> parentVal</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!parentVal) &#123;</span><br><span class="line">            <span class="keyword">return</span> childVal</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// when parentVal &amp; childVal are both present,</span></span><br><span class="line">        <span class="comment">// we need to return a function that returns the</span></span><br><span class="line">        <span class="comment">// merged result of both functions... no need to</span></span><br><span class="line">        <span class="comment">// check if parentVal is a function here because</span></span><br><span class="line">        <span class="comment">// it has to be a function to pass previous merges.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">mergedDataFn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> mergeData(<span class="keyword">typeof</span> childVal === <span class="string">'function'</span> ? childVal.call(<span class="keyword">this</span>, <span class="keyword">this</span>) : childVal, <span class="keyword">typeof</span> parentVal === <span class="string">'function'</span> ? parentVal.call(<span class="keyword">this</span>, <span class="keyword">this</span>) : parentVal)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">mergedInstanceDataFn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// instance merge</span></span><br><span class="line">            <span class="keyword">const</span> instanceData = <span class="keyword">typeof</span> childVal === <span class="string">'function'</span> ? childVal.call(vm, vm) : childVal</span><br><span class="line">            <span class="keyword">const</span> defaultData = <span class="keyword">typeof</span> parentVal === <span class="string">'function'</span> ? parentVal.call(vm, vm) : parentVal</span><br><span class="line">            <span class="keyword">if</span> (instanceData) &#123;</span><br><span class="line">                <span class="keyword">return</span> mergeData(instanceData, defaultData)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> defaultData</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果处理的是子组件选项：</p>
<ul>
<li>子选项不存在，则使用父选项</li>
<li><p>父选项不存在，则使用子选项</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Vue不存在data选项，所以使用子选项</span></span><br><span class="line"><span class="keyword">const</span> ParentComponent = Vue.extend(&#123;</span><br><span class="line">    data() &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            a: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// ParentComponent存在data选项，而子选项不存在，使用父选项</span></span><br><span class="line"><span class="keyword">const</span> childCompoent = ParentComponent.extend(&#123;&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>子选项与父选项都存在，则返回<code>mergedDataFn</code>函数</p>
</li>
</ul>
<p>我们可以发现<code>mergeDataorFn</code>函数在处理子组件选项时返回的总是一个函数，这也就是间接导致<code>strats.data</code>策略函数在处理子组件选项时返回的也总是一个函数</p>
<p>如果处理的不是子组件选项：返回<code>mergedInstanceDataFn</code>函数</p>
<p><code>mergeDataorFn</code>和<code>mergedInstanceDataFn</code>中的代码类似，都是调用<code>mergeData</code>方法，传入父 data 以及子 data，如果<code>data</code>是个<code>function</code>，则调用该<code>function</code>生成一个 data 对象。TODO:这里有个疑问，当处理的是子组件的选项时，感觉不需要再判断<code>childVal</code>和<code>parentVal</code>是否是<code>function</code>了，因为它们一定是<code>function</code>，这在<code>strats.data</code>中已经判断了的。</p>
<p>我们接着看<code>mergeData</code>方法，它才是终极的合并策略，其源码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Helper that recursively merges two data objects together.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeData</span>(<span class="params">to: Object, from: ?Object</span>): <span class="title">Object</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">from</span>) <span class="keyword">return</span> to</span><br><span class="line">    <span class="keyword">let</span> key, toVal, fromVal</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> keys = hasSymbol ? <span class="built_in">Reflect</span>.ownKeys(<span class="keyword">from</span>) : <span class="built_in">Object</span>.keys(<span class="keyword">from</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">        key = keys[i]</span><br><span class="line">        <span class="comment">// in case the object is already observed...</span></span><br><span class="line">        <span class="keyword">if</span> (key === <span class="string">'__ob__'</span>) <span class="keyword">continue</span></span><br><span class="line">        toVal = to[key]</span><br><span class="line">        fromVal = <span class="keyword">from</span>[key]</span><br><span class="line">        <span class="keyword">if</span> (!hasOwn(to, key)) &#123;</span><br><span class="line">            set(to, key, fromVal)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (toVal !== fromVal &amp;&amp; isPlainObject(toVal) &amp;&amp; isPlainObject(fromVal)) &#123;</span><br><span class="line">            mergeData(toVal, fromVal)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> to</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>mergeData</code>的参数<code>to</code>代表的是<code>childData</code>，<code>from</code>代表的是<code>parentData</code>。这里值得注意的几点有：</p>
<ol>
<li><code>mergeData</code>的函数目的是把<code>parentData</code>的属性添加到<code>childData</code>上。如果<code>parentData</code>上的属性不存在于<code>childData</code>上，则调用<code>set</code>函数把这个属性添加到<code>childData</code>上；如果<code>parentData</code>上的属性存在于<code>childData</code>中且都为纯对象，则递归调用<code>mergeData</code>进行深度合并。</li>
<li><code>Object.keys</code>无法遍历出<code>symbol</code>属性，而<code>Reflect.ownKeys</code>可以，<code>Reflect</code>是一个内置的对象，它提供拦截 JavaScript 操作的方法。</li>
<li>如果<code>key</code>为<code>__ob__</code>，TODO:</li>
</ol>
<p>上面提到了一个<code>set</code>函数，这个函数来自于<code>src/core/observe/index.js</code>，实际上这个<code>set</code>函数就是<code>Vue</code>暴露给我的全局 API<code>Vue.set</code>，TODO:。</p>
<p>最后我们对大家经常会产生疑问的地方做一些补充：</p>
<h2 id="一、为什么最终strats-data会被处理成一个函数"><a href="#一、为什么最终strats-data会被处理成一个函数" class="headerlink" title="一、为什么最终strats.data会被处理成一个函数"></a>一、为什么最终<code>strats.data</code>会被处理成一个函数</h2><p>这是因为，通过函数返回数据对象，保证了每个组件实例都有一个唯一的数据副本，避免了组件间数据互相影响。</p>
<h2 id="二、为什么不在合并阶段就把数据合并好，而是要等到初始化的时候再合并数据"><a href="#二、为什么不在合并阶段就把数据合并好，而是要等到初始化的时候再合并数据" class="headerlink" title="二、为什么不在合并阶段就把数据合并好，而是要等到初始化的时候再合并数据"></a>二、为什么不在合并阶段就把数据合并好，而是要等到初始化的时候再合并数据</h2><p>这个问题是什么意思呢？我们知道在合并阶段<code>strats.data</code>将被处理成一个函数，但是这个函数并没有被执行，而是到了后面初始化的阶段才执行的，这个时候才会调用<code>mergeData</code>对数据进行合并处理，那么这么做的目的是什么呢？</p>
<p>其实这么做是有原因的，后面讲到<code>Vue</code>的初始化的时候，大家就会发现<code>inject</code>和<code>props</code>这两个的选项的初始化是优先于<code>data</code>选项的，这就保证了我们能够使用<code>props</code>初始化<code>data</code>中的数据，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 子组件：使用 props 初始化子组件的 childData</span></span><br><span class="line"><span class="keyword">const</span> Child = &#123;</span><br><span class="line">    template: <span class="string">'&lt;span&gt;&lt;/span&gt;'</span>,</span><br><span class="line">    data() &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            childData: <span class="keyword">this</span>.parentData</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    props: [<span class="string">'parentData'</span>],</span><br><span class="line">    created() &#123;</span><br><span class="line">        <span class="comment">// 这里将输出 parent</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.childData)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">'#app'</span>,</span><br><span class="line">    <span class="comment">// 通过 props 向子组件传递数据</span></span><br><span class="line">    template: <span class="string">'&lt;child parent-data="parent" /&gt;'</span>,</span><br><span class="line">    components: &#123;</span><br><span class="line">        Child</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>如上例所示，子组件的数据<code>childData</code>的初始值就是<code>parentData</code>这个<code>props</code>，而之所以能够这样做的原因有两个：</p>
<ol>
<li>由于<code>props</code>的初始化先于<code>data</code>选项的初始化</li>
<li><code>data</code>选项是在初始化的时候才求值的，你也可以理解为在初始化的时候才使用<code>mergeData</code>进行数据合并</li>
</ol>
<h2 id="三、你可以这么做"><a href="#三、你可以这么做" class="headerlink" title="三、你可以这么做"></a>三、你可以这么做</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">data (vm) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    childData: vm.parentData</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 或者使用更简单的解构赋值</span></span><br><span class="line">data (&#123; parentData &#125;) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    childData: parentData</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>data 函数的参数实际上就是当前实例对象。那么这个参数是在哪里传进来的呢？其实有两个地方，其中一个地方我们前面见过了，如下面这段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> mergeData(<span class="keyword">typeof</span> childVal === <span class="string">'function'</span> ? childVal.call(<span class="keyword">this</span>, <span class="keyword">this</span>) : childVal, <span class="keyword">typeof</span> parentVal === <span class="string">'function'</span> ? parentVal.call(<span class="keyword">this</span>, <span class="keyword">this</span>) : parentVal)</span><br><span class="line"><span class="comment">// 和</span></span><br><span class="line"><span class="keyword">const</span> instanceData = <span class="keyword">typeof</span> childVal === <span class="string">'function'</span> ? childVal.call(vm, vm) : childVal</span><br><span class="line"><span class="keyword">const</span> defaultData = <span class="keyword">typeof</span> parentVal === <span class="string">'function'</span> ? parentVal.call(vm, vm) : parentVal</span><br></pre></td></tr></table></figure>
<p>当然仅仅在这里这么做是不够的，比如<code>mergeDataFn</code>前面的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!childVal) &#123;</span><br><span class="line">    <span class="keyword">return</span> parentVal</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!parentVal) &#123;</span><br><span class="line">    <span class="keyword">return</span> childVal</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这段代码中，直接将<code>parentVal</code>或<code>childVal</code>返回了，我们知道这里的<code>parentVal</code>和<code>childVal</code>就是<code>data</code>数，由于被直接返回，所以并没有指定其运行的作用域，且也没有传递当前实例作为参数，所以我们必然还是在其他地方做这些事情，而这个地方就是我们说的第二个地方，它在哪里呢？当然是初始化的时候，后面我们会讲到的，如果这里大家没有理解也不用担心。</p>
<h1 id="生命周期钩子选项的合并策略"><a href="#生命周期钩子选项的合并策略" class="headerlink" title="生命周期钩子选项的合并策略"></a>生命周期钩子选项的合并策略</h1><figure class="highlight javascript"><figcaption><span>Vue生命周期钩子</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> LIFECYCLE_HOOKS = [<span class="string">'beforeCreate'</span>, <span class="string">'created'</span>, <span class="string">'beforeMount'</span>, <span class="string">'mounted'</span>, <span class="string">'beforeUpdate'</span>, <span class="string">'updated'</span>, <span class="string">'beforeDestroy'</span>, <span class="string">'destroyed'</span>, <span class="string">'activated'</span>, <span class="string">'deactivated'</span>, <span class="string">'errorCaptured'</span>, <span class="string">'serverPrefetch'</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hooks and props are merged as arrays.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeHook</span>(<span class="params">parentVal: ?Array&lt;Function&gt;, childVal: ?Function | ?Array&lt;Function&gt;</span>): ?<span class="title">Array</span>&lt;<span class="title">Function</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> res = childVal ? (parentVal ? parentVal.concat(childVal) : <span class="built_in">Array</span>.isArray(childVal) ? childVal : [childVal]) : parentVal</span><br><span class="line">    <span class="keyword">return</span> res ? dedupeHooks(res) : res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dedupeHooks</span>(<span class="params">hooks</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> res = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; hooks.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (res.indexOf(hooks[i]) === <span class="number">-1</span>) &#123;</span><br><span class="line">            res.push(hooks[i])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LIFECYCLE_HOOKS.forEach(<span class="function"><span class="params">hook</span> =&gt;</span> &#123;</span><br><span class="line">    strats[hook] = mergeHook</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>整个函数体由三组三目运算符组成：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> (是否有 childVal，即判断组件的选项中是否有对应名字的生命周期钩子函数)</span><br><span class="line">  ? 如果有 childVal 则判断是否有 parentVal</span><br><span class="line">    ? 如果有 parentVal 则使用 concat 方法将二者合并为一个数组</span><br><span class="line">    : 如果没有 parentVal 则判断 childVal 是不是一个数组</span><br><span class="line">      ? 如果 childVal 是一个数组则直接返回</span><br><span class="line">      : 否则将其作为数组的元素，然后返回数组</span><br><span class="line">  : 如果没有 childVal 则直接返回 parentVal</span><br></pre></td></tr></table></figure>
<p>这里我们以<code>created</code>钩子为例，演示一下钩子函数的合并过程：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// from</span></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  created: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'created'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// to</span></span><br><span class="line">options.created = [</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'created'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// from</span></span><br><span class="line"><span class="keyword">const</span> Parent = Vue.extend(&#123;</span><br><span class="line">  created: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'parentVal'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> Child = <span class="keyword">new</span> Parent(&#123;</span><br><span class="line">  created: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'childVal'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// to</span></span><br><span class="line">options.created = [</span><br><span class="line">  created: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'parentVal'</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  created: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'childVal'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// from</span></span><br><span class="line"><span class="keyword">const</span> createFn</span><br><span class="line"><span class="keyword">const</span> Parent = Vue.extend(&#123;</span><br><span class="line">  created: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'parentVal'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Child = <span class="keyword">new</span> Parent(&#123;</span><br><span class="line">  created: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'childVal'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这里有个地方需要注意，那就是<code>dedupeHooks</code>函数做的事情：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createdFn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.name) <span class="comment">// 'ChildComponent'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> ParentComponent = Vue.extend(&#123;</span><br><span class="line">    data: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            name: <span class="string">'ParentComponent'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    created: createdFn</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ChildComponent = <span class="keyword">new</span> ParentComponent(&#123;</span><br><span class="line">    data: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            name: <span class="string">'ChildComponent'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    created: createdFn</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>如果两个 created 函数引用的是同一个函数，则只会调用一次，而调用时绑定的<code>this</code>作用域是最后引用的组件，具体需要查看调用方法的实现 TODO:</p>
<p>通过钩子函数的合并代码，我们能发现还有一个地方官方文档没有提及的就是钩子函数我们能够传入数组，例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    created: [</span><br><span class="line">        <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'first'</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'second'</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'third'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h1 id="资源（assets）选项的合并策略"><a href="#资源（assets）选项的合并策略" class="headerlink" title="资源（assets）选项的合并策略"></a>资源（assets）选项的合并策略</h1><figure class="highlight javascript"><figcaption><span>资源（assets）</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ASSET_TYPES = [<span class="string">'component'</span>, <span class="string">'directive'</span>, <span class="string">'filter'</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Assets</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * When a vm is present (instance creation), we need to do</span></span><br><span class="line"><span class="comment"> * a three-way merge between constructor options, instance</span></span><br><span class="line"><span class="comment"> * options and parent options.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeAssets</span>(<span class="params">parentVal: ?Object, childVal: ?Object, vm?: Component, key: string</span>): <span class="title">Object</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="built_in">Object</span>.create(parentVal || <span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">if</span> (childVal) &#123;</span><br><span class="line">        process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; assertObjectType(key, childVal, vm)</span><br><span class="line">        <span class="keyword">return</span> extend(res, childVal)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ASSET_TYPES.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">type</span>) </span>&#123;</span><br><span class="line">    strats[type + <span class="string">'s'</span>] = mergeAssets</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><code>assets</code>的合并策略：首先以<code>parentVal</code>为原型创建一个对象赋给<code>res</code>，然后判断<code>childVal</code>是否存在，如果存在且为纯对象，则调用<code>extend</code>方法进行合并，然后返回；如果<code>childVal</code>不存在，则直接返回<code>res</code></p>
<p>以<code>components</code>为例，假设我们有以下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> v = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">'#app'</span>,</span><br><span class="line">    components: &#123;</span><br><span class="line">        ChildComponent: ChildComponent</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>则合并后为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">res = &#123;</span><br><span class="line">  ChildComponent</span><br><span class="line">  <span class="comment">// 原型</span></span><br><span class="line">  __proto__: &#123;</span><br><span class="line">    KeepAlive,</span><br><span class="line">    Transition,</span><br><span class="line">    TransitionGroup</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以这就是为什么我们不用显示地注册组件就能够使用一些内置组件的原因，同时这也是内置组件的实现方式，通过<code>Vue.extend</code>创建出来的子类也是一样的道理，一层一层地通过原型进行组件的搜索。</p>
<h1 id="选项-watch-的合并策略"><a href="#选项-watch-的合并策略" class="headerlink" title="选项 watch 的合并策略"></a>选项 watch 的合并策略</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Watchers.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Watchers hashes should not overwrite one</span></span><br><span class="line"><span class="comment"> * another, so we merge them as arrays.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">strats.watch = <span class="function"><span class="keyword">function</span>(<span class="params">parentVal: ?Object, childVal: ?Object, vm?: Component, key: string</span>): ?<span class="title">Object</span> </span>&#123;</span><br><span class="line">    <span class="comment">// work around Firefox's Object.prototype.watch...</span></span><br><span class="line">    <span class="keyword">if</span> (parentVal === nativeWatch) parentVal = <span class="literal">undefined</span></span><br><span class="line">    <span class="keyword">if</span> (childVal === nativeWatch) childVal = <span class="literal">undefined</span></span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (!childVal) <span class="keyword">return</span> <span class="built_in">Object</span>.create(parentVal || <span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">        assertObjectType(key, childVal, vm)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!parentVal) <span class="keyword">return</span> childVal</span><br><span class="line">    <span class="keyword">const</span> ret = &#123;&#125;</span><br><span class="line">    extend(ret, parentVal)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> childVal) &#123;</span><br><span class="line">        <span class="keyword">let</span> parent = ret[key]</span><br><span class="line">        <span class="keyword">const</span> child = childVal[key]</span><br><span class="line">        <span class="keyword">if</span> (parent &amp;&amp; !<span class="built_in">Array</span>.isArray(parent)) &#123;</span><br><span class="line">            parent = [parent]</span><br><span class="line">        &#125;</span><br><span class="line">        ret[key] = parent ? parent.concat(child) : <span class="built_in">Array</span>.isArray(child) ? child : [child]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有几点需要注意：</p>
<ol>
<li>判断了<code>parentVal</code>和<code>childVal</code>是否等于<code>nativeWatch</code>，如果是，则重置为<code>undefined</code>。这么做的原因是因为在<code>firefox</code>浏览器中，<code>Object.prototype</code>拥有原生的<code>watch</code>函数。</li>
<li>被处理后的<code>watch</code>选项下的每个键值，有可能是一个数组，也有可能是一个函数。</li>
<li><p><code>watch</code>选项允许我们传入一个数组，类似于钩子函数，不同于钩子函数的地方在于对同一个函数的引用会触发两次调用，如下：</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">watchFn</span>(<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>, newVal) <span class="comment">// 会打印两次，this都指向ChildComponent</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> ParentComponent = Vue.extend(&#123;</span><br><span class="line">    data: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            name: <span class="string">'ParentComponent'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    watch: &#123;</span><br><span class="line">        name: watchFn</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ChildComponent = <span class="keyword">new</span> ParentComponent(&#123;</span><br><span class="line">    data: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            name: <span class="string">'ChildComponent'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    watch: &#123;</span><br><span class="line">        name: watchFn</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">ChildComponent.name = <span class="string">'222'</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="选项props、method、inject、computed的合并策略"><a href="#选项props、method、inject、computed的合并策略" class="headerlink" title="选项props、method、inject、computed的合并策略"></a>选项props、method、inject、computed的合并策略</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Other object hashes.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">strats.props =</span><br><span class="line">strats.methods =</span><br><span class="line">strats.inject =</span><br><span class="line">strats.computed = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentVal: ?Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  childVal: ?Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  vm?: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): ?<span class="title">Object</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (childVal &amp;&amp; process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    assertObjectType(key, childVal, vm)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!parentVal) <span class="keyword">return</span> childVal</span><br><span class="line">  <span class="keyword">const</span> ret = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  extend(ret, parentVal)</span><br><span class="line">  <span class="keyword">if</span> (childVal) extend(ret, childVal)</span><br><span class="line">  <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于<code>props、method、inject、computed</code>这四个选项有一个共同点，就是它们的结构都是纯对象，虽然我们在书写<code>props</code>或者<code>inject</code>选项的时候可能是一个数组，但是在<a href="/2019/03/26/Vue选项的规范化.html">Vue选项的规范化</a>这一节我们知道，<code>Vue</code>内部都将其规范化为了一个对象</p>
<h1 id="选项provide的合并策略"><a href="#选项provide的合并策略" class="headerlink" title="选项provide的合并策略"></a>选项provide的合并策略</h1><p>最后一个选项的合并策略，就是<code>provide</code>选项的合并策略，只有一句代码，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strats.provide = mergeDataOrFn</span><br></pre></td></tr></table></figure>
<p>也就是<code>provide</code>选项的合并策略与<code>data</code>选项的合并策略相同，都是使用<code>mergeDataOrFn</code>函数</p>
<h1 id="选项处理小结"><a href="#选项处理小结" class="headerlink" title="选项处理小结"></a>选项处理小结</h1><p>现在我们了解了 Vue 中是如何合并处理选项的，接下来我们稍微做一个总结：</p>
<ul>
<li>对于 <code>el、propsData</code>选项使用默认的合并策略<code>defaultStrat</code>。</li>
<li>对于 <code>data</code> 选项，使用 <code>mergeDataOrFn</code> 函数进行处理，最终结果是 <code>data</code> 选项将变成一个函数，且该函数的执行结果为真正的数据对象。</li>
<li>对于 生命周期钩子 选项，将合并成数组，使得父子选项中的钩子函数都能够被执行</li>
<li>对于 <code>directives、filters</code> 以及 <code>components</code> 等资源选项，父子选项将以原型链的形式被处理，正是因为这样我们才能够在任何地方都使用内置组件、指令等。</li>
<li>对于 <code>watch</code> 选项的合并处理，类似于生命周期钩子，如果父子选项都有相同的观测字段，将被合并为数组，这样观察者都将被执行。</li>
<li>对于 <code>props、methods、inject、computed</code> 选项，父选项始终可用，但是子选项会覆盖同名的父选项字段。</li>
<li>对于 <code>provide</code> 选项，其合并策略使用与 <code>data</code> 选项相同的 <code>mergeDataOrFn</code> 函数。</li>
<li>最后，以上没有提及到的选项都将使默认选项 <code>defaultStrat</code>。</li>
<li>最最后，默认合并策略函数 <code>defaultStrat</code> 的策略是：只要子选项不是 <code>undefined</code> 就使用子选项，否则使用父选项。</li>
</ul>
<p>至此，我们大概介绍完了 <code>Vue</code> 对选项的处理，但留心的同学一定注意到了，<code>options.js</code> 文件的代码我们都基本逐行分析，唯独剩下一个函数我们始终没有提到，它就是 <code>resolveAsset</code> 函数。这个函数我们暂且不在这里讲，后面随着我们的深入，自然会再次碰到它，到那个时候应该是讲它的最好时机。</p>
<h1 id="再看mixins和extends"><a href="#再看mixins和extends" class="headerlink" title="再看mixins和extends"></a>再看mixins和extends</h1><p>在<a href="/2019/03/26/Vue选项的规范化.html">Vue选项的规范化</a>一节中，我们讲到了<code>mergeOptions</code>函数中的如下这段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Apply extends and mixins on the child options,</span></span><br><span class="line"><span class="comment">// but only if it is a raw options object that isn't</span></span><br><span class="line"><span class="comment">// the result of another mergeOptions call.</span></span><br><span class="line"><span class="comment">// Only merged options has the _base property.</span></span><br><span class="line"><span class="keyword">if</span> (!child._base) &#123;</span><br><span class="line">    <span class="keyword">if</span> (child.extends) &#123;</span><br><span class="line">        parent = mergeOptions(parent, child.extends, vm)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (child.mixins) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = child.mixins.length; i &lt; l; i++) &#123;</span><br><span class="line">            parent = mergeOptions(parent, child.mixins[i], vm)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们知道<code>mixins</code>在<code>Vue</code>中用于解决代码复用的问题，比如混入<code>created</code>生命周期钩子，用于打印一句话：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> consoleMixin = &#123;</span><br><span class="line">  created () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'created:mixins'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue (&#123;</span><br><span class="line">  mixins: [consoleMixin],</span><br><span class="line">  created () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'created:instance'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>运行以上代码，将打印两句话：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// created:mixins</span></span><br><span class="line"><span class="comment">// created:instance</span></span><br></pre></td></tr></table></figure>
<p>这是因为<code>mergeOptions</code>函数在处理<code>mixins</code>选项的时候递归调用了<code>mergeOptions</code>函数将<code>mixins</code>合并到了<code>parent</code>中，并将合并后生成的新对象作为新的<code>parent</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (child.mixins) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = child.mixins.length; i &lt; l; i++) &#123;</span><br><span class="line">    parent = mergeOptions(parent, child.mixins[i], vm)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上例中我们只涉及到<code>created</code>生命周期钩子的合并，所以会使用生命周期钩子的合并策略函数进行处理，现在我们已经知道<code>mergeOptions</code>会把生命周期选项合并为一个数组，所以所有的生命周期钩子都会被执行。那么不仅仅是生命周期钩子，任何写在<code>mixins</code>中的选项，都会使用<code>mergeOptions</code>中相应的合并策略进行处理，这就是<code>mixins</code>的实现方式。</p>
<p>对于<code>extends</code>选项，与<code>mixins</code>相同，甚至由于<code>extends</code>选项只能是一个对象，而不能是数组，反而要比<code>mixins</code>的实现更为简单，连遍历都不需要。</p>
<p>下一篇：<a href="/2019/03/28/Vue的初始化之开篇.html">Vue的初始化之开篇</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/26/Vue选项的规范化.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cong.Wang">
      <meta itemprop="description" content="WgCg、Cong.Wang、WangCong、Vue、Webpack、HTML、CSS、JS">
      <meta itemprop="image" content="/uploads/mine/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WgCg Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/26/Vue选项的规范化.html" class="post-title-link" itemprop="url">Vue选项的规范化</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-26 11:25:26" itemprop="dateCreated datePublished" datetime="2019-03-26T11:25:26+08:00">2019-03-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-27 13:46:16" itemprop="dateModified" datetime="2019-03-27T13:46:16+08:00">2019-03-27</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/" itemprop="url" rel="index"><span itemprop="name">框架</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/Vue/" itemprop="url" rel="index"><span itemprop="name">Vue</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/Vue/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/26/Vue选项的规范化.html#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/26/Vue选项的规范化.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/03/26/Vue选项的规范化.html" class="leancloud_visitors" data-flag-title="Vue选项的规范化">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">6.1k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">6 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这节主要是对 <code>mergeOptions</code> 方法进行说明，根据<code>core/instance/init.js</code>顶部的引用关系可知，<code>mergeOptions</code>函数来自于<code>src/core/util/options.js</code>文件，事实上不仅仅是<code>mergeOptions</code>函数，整个文件所做的一切都是为了一件事：选项的合并</p>
<h1 id="弄清楚传递给-mergeOptions-函数的三个参数"><a href="#弄清楚传递给-mergeOptions-函数的三个参数" class="headerlink" title="弄清楚传递给 mergeOptions 函数的三个参数"></a>弄清楚传递给 mergeOptions 函数的三个参数</h1><p>首先，我们需要搞清楚一件事，就是如下代码中传递给<code>mergeOptions</code>函数的三个参数到底是什么</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vm.$options = mergeOptions(</span><br><span class="line">    resolveConstructorOptions(vm.constructor),</span><br><span class="line">    options || &#123;&#125;,</span><br><span class="line">    vm</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ol>
<li><p>第一个参数是通过调用<code>resolveConstructorOptions</code>函数得到的，并将<code>vm.constructor</code>作为参数传递进去，这个函数声明在<code>src/core/instance/init.js</code>文件中，如下：</p>
 <figure class="highlight javascript"><figcaption><span>resolveConstructorOptions</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveConstructorOptions</span> (<span class="params">Ctor: Class&lt;Component&gt;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> options = Ctor.options</span><br><span class="line">    <span class="keyword">if</span> (Ctor.super) &#123;</span><br><span class="line">        <span class="keyword">const</span> superOptions = resolveConstructorOptions(Ctor.super)</span><br><span class="line">        <span class="keyword">const</span> cachedSuperOptions = Ctor.superOptions</span><br><span class="line">        <span class="keyword">if</span> (superOptions !== cachedSuperOptions) &#123;</span><br><span class="line">        <span class="comment">// super option changed,</span></span><br><span class="line">        <span class="comment">// need to resolve new options.</span></span><br><span class="line">        Ctor.superOptions = superOptions</span><br><span class="line">        <span class="comment">// check if there are any late-modified/attached options (#4976)</span></span><br><span class="line">        <span class="keyword">const</span> modifiedOptions = resolveModifiedOptions(Ctor)</span><br><span class="line">        <span class="comment">// update base extend options</span></span><br><span class="line">        <span class="keyword">if</span> (modifiedOptions) &#123;</span><br><span class="line">            extend(Ctor.extendOptions, modifiedOptions)</span><br><span class="line">        &#125;</span><br><span class="line">        options = Ctor.options = mergeOptions(superOptions, Ctor.extendOptions)</span><br><span class="line">        <span class="keyword">if</span> (options.name) &#123;</span><br><span class="line">            options.components[options.name] = Ctor</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> options</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>声明<code>options</code>变量，初始化为当前实例构造函数的<code>options</code>，在这个例子中<code>Ctor</code>是<code>Vue</code>（如果是实例化通过<code>Vue.extend</code>创建的子类，那么这里的<code>Ctor</code>就不是<code>Vue</code>，而是该子类），然后返回<code>options</code>变量</li>
<li>如果<code>Ctor.super</code>存在（该实例是通过实例化<code>Vue.extend</code>创建的子类实现的），则执行<code>if</code>判断语句里面的代码</li>
<li><p>该函数的作用就是用来获取当前实例构造者的<code>options</code>属性（在这个例子中就是Vue.options，如下）</p>
 <figure class="highlight javascript"><figcaption><span>Vue.options</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Vue.options = &#123;</span><br><span class="line">    components: &#123;</span><br><span class="line">        KeepAlive</span><br><span class="line">        Transition,</span><br><span class="line">        TransitionGroup</span><br><span class="line">    &#125;,</span><br><span class="line">    directives:&#123;</span><br><span class="line">        model,</span><br><span class="line">        show</span><br><span class="line">    &#125;,</span><br><span class="line">    filters: <span class="built_in">Object</span>.create(<span class="literal">null</span>),</span><br><span class="line">    _base: Vue</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>第二个参数就是我们调用<code>Vue</code>构造函数传进来的参数</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    el: <span class="string">'#app'</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        test: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三个参数<code>vm</code>是实例对象本身</p>
</li>
</ol>
<h1 id="检查组件名称是否符合要求"><a href="#检查组件名称是否符合要求" class="headerlink" title="检查组件名称是否符合要求"></a>检查组件名称是否符合要求</h1><p>打开<code>src/core/util/options.js</code>，找到<code>mergeOptions</code>方法，这个方法上面有一段注释：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Merge two option objects into a new one.</span></span><br><span class="line"><span class="comment"> * Core utility used in both instantiation and inheritance.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>合并两个对象为一个对象，这个函数不仅仅在实例化对象（即<code>_init</code>方法中）的时候用到，在继承（<code>Vue.extend</code>）中也有用到，所以这个函数是一个用来合并两个选项对象为一个新对象的通用程序。</p>
<p>开始的一段代码如下，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">  checkComponents(child)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在非生产环境下，会以<code>child</code>对象（构造实例时传入的options）为参数，调用<code>checkComponents</code>方法，该方法是用来校验组件名是否符合要求的，组件名的要求如下</p>
<ol>
<li>组件的名称需要满足正则表达式：<code>/^[a-zA-Z][\\-\\.0-9_a-zA-Z\u00B7\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u037D\u037F-\u1FFF\u200C-\u200D\u203F-\u2040\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]*$/</code></li>
<li>要满足：条件<code>isBuiltInTag(name) || config.isReservedTag(name)</code>不成立<ol>
<li><code>isBuitlInTag</code>检测是否是内置标签（slot、component）</li>
<li><code>config.isReservedTag</code>检测是否是保留标签，<code>isReservedTag</code>方法在<code>src/platform/web/runtime/index.js</code>中被初始化，通过查看可知在<code>Vue</code>中<code>html</code>标签和部分<code>SVG</code>标签被认为是保留的</li>
</ol>
</li>
</ol>
<h1 id="允许合并另一个实例构造者的选项"><a href="#允许合并另一个实例构造者的选项" class="headerlink" title="允许合并另一个实例构造者的选项"></a>允许合并另一个实例构造者的选项</h1><p>我们继续看代码，接下来的一段代码同样是一个<code>if</code>语句块</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> child === <span class="string">'function'</span>) &#123;</span><br><span class="line">  child = child.options</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这说明<code>child</code>参数除了是普通的选项对象外，还可以是一个函数，如果是函数的话就取该函数的<code>options</code>静态属性作为新的<code>child</code>。<code>Vue</code>和通过<code>Vue.extend</code>创造出来的子类拥有<code>options</code>属性。所以这就允许我们在进行选项合并的时候，去合并一个<code>Vue</code>实例构造者的选项了。</p>
<h1 id="规范化选项（props-inject-directives）"><a href="#规范化选项（props-inject-directives）" class="headerlink" title="规范化选项（props, inject, directives）"></a>规范化选项（props, inject, directives）</h1><p>接着看代码，接下来是三个用来规范化选项的函数调用，因为<code>Vue</code>中拥有多种使用方法的选项有很多，例如<code>props</code>，即可以传<code>Array</code>也可以传<code>Object</code>，为了在选项合并的时候能够统一处理，所以需要将其规范成同一种方式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">normalizeProps(child, vm)</span><br><span class="line">normalizeInject(child, vm)</span><br><span class="line">normalizeDirectives(child)</span><br></pre></td></tr></table></figure>
<ol>
<li><p>normalizeProps: 将props统一规范为对象的形式</p>
 <figure class="highlight javascript"><figcaption><span>props规范化</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// from</span></span><br><span class="line">&#123;</span><br><span class="line">    props: [<span class="string">'demo-props'</span>] <span class="comment">// 非字符串将会报错</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// to</span></span><br><span class="line">&#123;</span><br><span class="line">    props: &#123;</span><br><span class="line">        demoProps: &#123;</span><br><span class="line">            type: <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// from</span></span><br><span class="line">&#123;</span><br><span class="line">    props: &#123;</span><br><span class="line">        DemoProps: &#123;</span><br><span class="line">            type: <span class="built_in">Number</span>,</span><br><span class="line">            <span class="keyword">default</span>: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// to</span></span><br><span class="line">&#123;</span><br><span class="line">    props: &#123;</span><br><span class="line">        demoProps: &#123;</span><br><span class="line">            type: <span class="built_in">Number</span>,</span><br><span class="line">            <span class="keyword">default</span>: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// from</span></span><br><span class="line">&#123;</span><br><span class="line">    props: &#123;</span><br><span class="line">        DemoProps: <span class="built_in">Number</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// to</span></span><br><span class="line">&#123;</span><br><span class="line">    props: &#123;</span><br><span class="line">        demoProps: &#123;</span><br><span class="line">            type: <span class="built_in">Number</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>normalizeInject: 将inject统一规范为对象的形式</p>
 <figure class="highlight javascript"><figcaption><span>inject规范化</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// from</span></span><br><span class="line">&#123;</span><br><span class="line">    inject: [<span class="string">'data1'</span>, <span class="string">'data2'</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// to</span></span><br><span class="line">&#123;</span><br><span class="line">    inject: &#123;</span><br><span class="line">        <span class="string">'data1'</span>: &#123; <span class="attr">from</span>: <span class="string">'data1'</span> &#125;</span><br><span class="line">        <span class="string">'data2'</span>: &#123; <span class="attr">from</span>: <span class="string">'data2'</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// from</span></span><br><span class="line"><span class="keyword">let</span> data1 = <span class="string">'data1'</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    data1,</span><br><span class="line">    d2: <span class="string">'data2'</span>,</span><br><span class="line">    data3: &#123;</span><br><span class="line">        someProperty: <span class="string">'someValue'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// to</span></span><br><span class="line">&#123;</span><br><span class="line">    data1: &#123; <span class="attr">from</span>: <span class="string">'data1'</span> &#125;,</span><br><span class="line">    d2: &#123; <span class="attr">from</span>: <span class="string">'data2'</span> &#125;,</span><br><span class="line">    data3: &#123;</span><br><span class="line">        <span class="keyword">from</span>: <span class="string">'data3'</span>,</span><br><span class="line">        someProperty: <span class="string">'someValue'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>normalizeDirectives：将<code>directives</code>统一规范为对象的形式</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// from</span></span><br><span class="line">&#123;</span><br><span class="line">    directives: &#123;</span><br><span class="line">        test1: <span class="function"><span class="keyword">function</span> (<span class="params">el</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'v-test1'</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        test2: &#123;</span><br><span class="line">            bind: <span class="function"><span class="keyword">function</span> (<span class="params">el</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'v-test2'</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// to</span></span><br><span class="line">&#123;</span><br><span class="line">    directives: &#123;</span><br><span class="line">        test1: &#123;</span><br><span class="line">            bind: <span class="function"><span class="keyword">function</span> (<span class="params">el</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'v-test1'</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">            update: <span class="function"><span class="keyword">function</span> (<span class="params">el</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'v-test1'</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        test2: &#123;</span><br><span class="line">            bind: <span class="function"><span class="keyword">function</span> (<span class="params">el</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'v-test2'</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="处理-extends-和-mixins"><a href="#处理-extends-和-mixins" class="headerlink" title="处理 extends 和 mixins"></a>处理 <code>extends</code> 和 <code>mixins</code></h1><p>规范化<code>props、inject、directives</code>之后的一段代码是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Apply extends and mixins on the child options,</span></span><br><span class="line"><span class="comment">// but only if it is a raw options object that isn't</span></span><br><span class="line"><span class="comment">// the result of another mergeOptions call.</span></span><br><span class="line"><span class="comment">// Only merged options has the _base property.</span></span><br><span class="line"><span class="keyword">if</span> (!child._base) &#123;</span><br><span class="line">    <span class="keyword">if</span> (child.extends) &#123;</span><br><span class="line">        parent = mergeOptions(parent, child.extends, vm)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (child.mixins) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = child.mixins.length; i &lt; l; i++) &#123;</span><br><span class="line">            parent = mergeOptions(parent, child.mixins[i], vm)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>递归调用<code>mergeOptions</code>方法，将<code>child.exnteds</code>和<code>child.mexins</code>合并到<code>parent</code>上，直到<code>child</code>为<code>Vue</code>时，只有<code>Vue</code>上有<code>_base</code>属性，其直为<code>Vue</code></p>
<p>下一篇：<a href="/2019/03/27/Vue选项的合并.html">Vue选项的合并</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/21/以一个例子为线索.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cong.Wang">
      <meta itemprop="description" content="WgCg、Cong.Wang、WangCong、Vue、Webpack、HTML、CSS、JS">
      <meta itemprop="image" content="/uploads/mine/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WgCg Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/21/以一个例子为线索.html" class="post-title-link" itemprop="url">以一个例子为线索</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-21 16:37:16" itemprop="dateCreated datePublished" datetime="2019-03-21T16:37:16+08:00">2019-03-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-26 11:25:46" itemprop="dateModified" datetime="2019-03-26T11:25:46+08:00">2019-03-26</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/" itemprop="url" rel="index"><span itemprop="name">框架</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/Vue/" itemprop="url" rel="index"><span itemprop="name">Vue</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/Vue/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/21/以一个例子为线索.html#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/21/以一个例子为线索.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/03/21/以一个例子为线索.html" class="leancloud_visitors" data-flag-title="以一个例子为线索">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">4.2k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">4 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>假设我们有如下模板：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span>&#123;&#123;test&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>和这样一段 js 代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">'#app'</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        test: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这段<code>js</code>代码很简单，我们只是简单的调用了<code>Vue</code>，传递了两个选项<code>el</code>和<code>data</code>。这段代码的最终效果就是在页面中渲染如下的<code>DOM</code>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中<code></code>被替换成了<code>1</code>，并且当我们尝试修改<code>data.set</code>的时候</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vm.$data.test = <span class="number">2</span></span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line">vm.test = <span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>那么页面的<code>DOM</code>也会随之变化为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们从<code>new Vue()</code>的操作开始分析，从<a href="/2019/03/20/Vue构造函数.html">Vue 构造函数</a>这章中我们得知<code>Vue</code>构造函数定义在<code>src/core/instance/index.js</code>中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; !(<span class="keyword">this</span> <span class="keyword">instanceof</span> Vue)) &#123;</span><br><span class="line">        warn(<span class="string">'Vue is a constructor and should be called with the `new` keyword'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>._init(options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一目了然，这里首先进行了一个判断，在非生产环境不通过<code>new</code>操作符执行<code>Vue</code>函数时，会给予一个警告，然后调用了<code>_init</code>方法，<code>_init</code>方法是在<code>initMixin</code>方法中添加到<code>Vue.prototype</code>上的，<code>initMixin</code>方法是在<code>src/core/instance/init.js</code>中声明的，并把 options 作为参数传入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">options = &#123;</span><br><span class="line">    el: <span class="string">'#app'</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">        test: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们来看看<code>_init</code>方法的具体代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm: Component = <span class="keyword">this</span></span><br><span class="line"><span class="comment">// a uid</span></span><br><span class="line">vm._uid = uid++</span><br></pre></td></tr></table></figure>
<ol>
<li>把当前实例对象赋给变量 vm</li>
<li>往 vm 实例上添加了一个唯一标识_uid，其值为<code>uid</code>，<code>uid</code>是在<code>initMixin</code>上发定义的初始化为 0，每次创建一个<code>Vue</code>实例后，<code>uid</code>的值便会加 1</li>
</ol>
<figure class="highlight javascript"><figcaption><span>性能追踪代码</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> startTag, endTag</span><br><span class="line"><span class="comment">/* istanbul ignore if */</span></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; config.performance &amp;&amp; mark) &#123;</span><br><span class="line">    startTag = <span class="string">`vue-perf-start:<span class="subst">$&#123;vm._uid&#125;</span>`</span></span><br><span class="line">    endTag = <span class="string">`vue-perf-end:<span class="subst">$&#123;vm._uid&#125;</span>`</span></span><br><span class="line">    mark(startTag)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 中间的代码省略...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* istanbul ignore if */</span></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; config.performance &amp;&amp; mark) &#123;</span><br><span class="line">    vm._name = formatComponentName(vm, <span class="literal">false</span>)</span><br><span class="line">    mark(endTag)</span><br><span class="line">    measure(<span class="string">`vue <span class="subst">$&#123;vm._name&#125;</span> init`</span>, startTag, endTag)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><code>config.performance</code>来自于<code>src/core/config.js</code>，<code>Vue</code>提供了全局配置<code>Vue.config.performance</code>，我们可以通过将其设置为<code>true</code>，即可开启性能追踪，你可以追踪四个场景的性能：<ol>
<li>组件初始化（<code>component init</code>），也就是上面的代码</li>
<li>编译（<code>compiler</code>），将模板（<code>template</code>）编译成渲染函数</li>
<li>渲染（<code>render</code>），其实就是渲染函数执行并且生成虚拟 DOM（<code>vnode</code>）的性能</li>
<li>打补丁，将虚拟 DOM 渲染成真实 DOM 的性能</li>
</ol>
</li>
<li><p><code>mark</code>与<code>measure</code>的定义来自于<code>src/core/util/perf.js</code>，实际上调用的 window.performance.mark 与 window.performance.measure</p>
 <figure class="highlight javascript"><figcaption><span>src/core/util/perf.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> mark</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> measure</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> perf = inBrowser &amp;&amp; <span class="built_in">window</span>.performance</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (perf &amp;&amp; perf.mark &amp;&amp; perf.measure &amp;&amp; perf.clearMarks &amp;&amp; perf.clearMeasures) &#123;</span><br><span class="line">        mark = <span class="function"><span class="params">tag</span> =&gt;</span> perf.mark(tag)</span><br><span class="line">        measure = <span class="function">(<span class="params">name, startTag, endTag</span>) =&gt;</span> &#123;</span><br><span class="line">            perf.measure(name, startTag, endTag)</span><br><span class="line">            perf.clearMarks(startTag)</span><br><span class="line">            perf.clearMarks(endTag)</span><br><span class="line">            <span class="comment">// perf.clearMeasures(name)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 <figure class="highlight javascript"><figcaption><span>window.performance demo</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> perf = <span class="built_in">window</span>.performance</span><br><span class="line"><span class="keyword">const</span> startTag = <span class="string">'perf-start'</span></span><br><span class="line"><span class="keyword">const</span> endTag = <span class="string">'perf-end'</span></span><br><span class="line"></span><br><span class="line">perf &amp;&amp; perf.mark(startTag)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (perf) &#123;</span><br><span class="line">    perf.mark(endTag)</span><br><span class="line">    perf.measure(<span class="string">'performance test'</span>, startTag, endTag)</span><br><span class="line">    <span class="built_in">console</span>.log(perf.getEntries())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在Chorme中可通过<code>Performance Tab</code>下的<code>Timings</code>查看记录的性能</p>
<p><img src="/assets/vue/theory/devtool-performance.jpg" width="500" title="View Performance Record By Chrome Devtool" alt="devtool-performance.jpg"></p>
</li>
</ol>
<figure class="highlight javascript"><figcaption><span>性能追踪中间的代码</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a flag to avoid this being observed</span></span><br><span class="line">vm._isVue = <span class="literal">true</span></span><br><span class="line"><span class="comment">// merge options</span></span><br><span class="line"><span class="keyword">if</span> (options &amp;&amp; options._isComponent) &#123;</span><br><span class="line">    <span class="comment">// optimize internal component instantiation</span></span><br><span class="line">    <span class="comment">// since dynamic options merging is pretty slow, and none of the</span></span><br><span class="line">    <span class="comment">// internal component options needs special treatment.</span></span><br><span class="line">    initInternalComponent(vm, options)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    vm.$options = mergeOptions(</span><br><span class="line">    resolveConstructorOptions(vm.constructor),</span><br><span class="line">    options || &#123;&#125;,</span><br><span class="line">    vm</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* istanbul ignore else */</span></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    initProxy(vm)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    vm._renderProxy = vm</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// expose real self</span></span><br><span class="line">vm._self = vm</span><br><span class="line">initLifecycle(vm)</span><br><span class="line">initEvents(vm)</span><br><span class="line">initRender(vm)</span><br><span class="line">callHook(vm, <span class="string">'beforeCreate'</span>)</span><br><span class="line">initInjections(vm) <span class="comment">// resolve injections before data/props</span></span><br><span class="line">initState(vm)</span><br><span class="line">initProvide(vm) <span class="comment">// resolve provide after data/props</span></span><br><span class="line">callHook(vm, <span class="string">'created'</span>)</span><br></pre></td></tr></table></figure>
<p>上面的代码是性能追踪代码中间的代码，主要做了以下几件事：</p>
<ol>
<li>在<code>Vue</code>实例上增加了<code>_isVue</code>属性，用来表示一个对象是否是<code>Vue</code>实例。这样可以避免被响应系统观测（其实在其它地方也有用到，但是宗旨是一样的）</li>
<li>判断<code>options._isComponent</code>属性是否存在（该属性是调用<code>Vue.component</code>方法时，追加的一个内部属性），如果存在，TODO:，如果不存在，往当前实例上追加<code>$options</code>属性（在上面代码中一系列init的初始化方法中用到）</li>
<li>调用了一系列的init初始化方法</li>
</ol>
<p>下一篇：<a href="/2019/03/26/Vue选项的规范化.html">Vue选项的规范化</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/20/了解Vue这个项目.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cong.Wang">
      <meta itemprop="description" content="WgCg、Cong.Wang、WangCong、Vue、Webpack、HTML、CSS、JS">
      <meta itemprop="image" content="/uploads/mine/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WgCg Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/20/了解Vue这个项目.html" class="post-title-link" itemprop="url">了解Vue这个项目</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-20 20:59:45" itemprop="dateCreated datePublished" datetime="2019-03-20T20:59:45+08:00">2019-03-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-26 11:22:59" itemprop="dateModified" datetime="2019-03-26T11:22:59+08:00">2019-03-26</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/" itemprop="url" rel="index"><span itemprop="name">框架</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/Vue/" itemprop="url" rel="index"><span itemprop="name">Vue</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/Vue/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/20/了解Vue这个项目.html#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/20/了解Vue这个项目.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/03/20/了解Vue这个项目.html" class="leancloud_visitors" data-flag-title="了解Vue这个项目">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">7.6k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">7 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p>最近在学习Vue源码，学习的路线主要是参考<a href="http://hcysun.me/vue-design/art/2vue-constructor.html" target="_blank" rel="noopener">Vue技术内幕</a>来的，阅读的过程中按照讲解一步步从浅入深，感觉自己还是跟的上的，但是当看完了一半的文章后，回过来想想又感觉自己什么都不懂，再往下读下去，我认为会非常吃力，并且最后的结果很可能是对于某一个知识点自己能稍微说的上来，但是对于整体的架构，某行具体的代码，为什么要这么做，这么做是为了解决什么样的问题等等一无所知，同时也为了以后能有个贯穿整体的复习资料再加上原文有些图片丢失了= =，就决定读完一章，便自己总结一下本章的内容，可能很多东西会跟原文的内容一致，毕竟有蝴蝶效应，但是聊胜于无，毕竟记录下来了，就相当于以自己的思路贯穿了一遍。</p>
<h1 id="立个Flag"><a href="#立个Flag" class="headerlink" title="立个Flag"></a>立个Flag</h1><p>果然，很多东西不定一个目标是无法达到自己的想要的目的，学习更是如此，每天的工作量不同导致自己看文章拖泥带水，有空的时候看看，没空的时候就不看，说实话，时间都是有的，没空只是安慰自己的借口，工作很累，下班了想要好好休息休息，我总是这么想，导致自己学东西特别的慢，不想利用自己业余时间去学习这个想法是阻碍我前进的根本原因，所以在这里立一个flag，一周之内也就是下周三（2019.3.27号）之前完成Vue源码的阅读，并产出相关的读书记录，希望这个flag能有用吧= =</p>
<h1 id="Vue目录分析"><a href="#Vue目录分析" class="headerlink" title="Vue目录分析"></a>Vue目录分析</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">├── scripts ------------------------------- 构建相关的文件，一般情况下我们不需要动</span><br><span class="line">│   ├── git-hooks ------------------------- 存放git钩子的目录</span><br><span class="line">│   ├── alias.js -------------------------- 路径别名配置</span><br><span class="line">│   ├── config.js ------------------------- 生成rollup配置的文件</span><br><span class="line">│   ├── build.js -------------------------- 对 config.js 中所有的rollup配置进行构建</span><br><span class="line">│   ├── ci.sh ----------------------------- 持续集成运行的脚本</span><br><span class="line">│   ├── release.sh ------------------------ 用于自动发布新版本的脚本</span><br><span class="line">├── dist ---------------------------------- 构建后文件的输出目录</span><br><span class="line">├── examples ------------------------------ 存放一些使用Vue开发的应用案例</span><br><span class="line">├── flow ---------------------------------- 类型声明，使用开源项目 [Flow](https://flowtype.org/)</span><br><span class="line">├── packages ------------------------------ 存放独立发布的包的目录</span><br><span class="line">├── <span class="built_in">test</span> ---------------------------------- 包含所有测试文件</span><br><span class="line">├── src ----------------------------------- 这个是我们最应该关注的目录，包含了源码</span><br><span class="line">│   ├── compiler -------------------------- 编译器代码的存放目录，将 template 编译为 render 函数</span><br><span class="line">│   ├── core ------------------------------ 存放通用的，与平台无关的代码</span><br><span class="line">│   │   ├── observer ---------------------- 响应系统，包含数据观测的核心代码</span><br><span class="line">│   │   ├── vdom -------------------------- 包含虚拟DOM创建(creation)和打补丁(patching)的代码</span><br><span class="line">│   │   ├── instance ---------------------- 包含Vue构造函数设计相关的代码</span><br><span class="line">│   │   ├── global-api -------------------- 包含给Vue构造函数挂载全局方法(静态方法)或属性的代码</span><br><span class="line">│   │   ├── components -------------------- 包含抽象出来的通用组件</span><br><span class="line">│   ├── server ---------------------------- 包含服务端渲染(server-side rendering)的相关代码</span><br><span class="line">│   ├── platforms ------------------------- 包含平台特有的相关代码，不同平台的不同构建的入口文件也在这里</span><br><span class="line">│   │   ├── web --------------------------- web平台</span><br><span class="line">│   │   │   ├── entry-runtime.js ---------- 运行时构建的入口，不包含模板(template)到render函数的编译器，所以不支持 `template` 选项，我们使用vue默认导出的就是这个运行时的版本。大家使用的时候要注意</span><br><span class="line">│   │   │   ├── entry-runtime-with-compiler.js -- 独立构建版本的入口，它在 entry-runtime 的基础上添加了模板(template)到render函数的编译器</span><br><span class="line">│   │   │   ├── entry-compiler.js --------- vue-template-compiler 包的入口文件</span><br><span class="line">│   │   │   ├── entry-server-renderer.js -- vue-server-renderer 包的入口文件</span><br><span class="line">│   │   │   ├── entry-server-basic-renderer.js -- 输出 packages/vue-server-renderer/basic.js 文件</span><br><span class="line">│   │   ├── weex -------------------------- 混合应用</span><br><span class="line">│   ├── sfc ------------------------------- 包含单文件组件(.vue文件)的解析逻辑，用于vue-template-compiler包</span><br><span class="line">│   ├── shared ---------------------------- 包含整个代码库通用的代码</span><br><span class="line">├── package.json -------------------------- 不解释</span><br><span class="line">├── yarn.lock ----------------------------- yarn 锁定文件</span><br><span class="line">├── .editorconfig ------------------------- 针对编辑器的编码风格配置文件</span><br><span class="line">├── .flowconfig --------------------------- flow 的配置文件</span><br><span class="line">├── .babelrc ------------------------------ babel 配置文件</span><br><span class="line">├── .eslintrc ----------------------------- eslint 配置文件</span><br><span class="line">├── .eslintignore ------------------------- eslint 忽略配置</span><br><span class="line">├── .gitignore ---------------------------- git 忽略配置</span><br></pre></td></tr></table></figure>
<h1 id="Vue的不同构建输出"><a href="#Vue的不同构建输出" class="headerlink" title="Vue的不同构建输出"></a>Vue的不同构建输出</h1><p>打开文件scripts/config.js，其中定义了builds对象，builds对象针对平台、环境、构建输出的模块方式、版本、使用方的不同进行了不同的配置，总结为：</p>
<ul>
<li>构建平台：web（浏览器）、web-server（服务器）、weex（开发原生应用程序的框架）。</li>
<li>版本：运行时版本、编译器、完整版本（运行时版本+编译器）。编译器提供了能够在运行时把template编译成render函数的能力，运行时版本比完整版本体积大约小于30%，同时提高了性能。</li>
<li>环境：development、production。（TODO:具体的差别）</li>
<li>模块：CommonJS、UMD、ES Module。UMD使得你可以直接通过<code>&lt;script&gt;</code>标签引用，而CommonJS形式的模块就是为<code>webpack 1</code>和<code>browserify</code>提供的，它们在加载模块的时候不能直接加载<code>ES Module</code>，而<code>Webpack 2</code>和<code>Rollup</code>是可以直接加载<code>ES Module</code>的，所以就有了<code>es</code>形式的模块输出。</li>
<li>使用方：Bundlers（打包工具，例如Webpack，Browserify等）、Browser（浏览器）</li>
</ul>
<p>TODO:下方列出了所有的构建项以及它们的大致区别，当然也不仅仅只是这些简单的区别，具体的区别还需要进一步分析。</p>
<table>
<thead>
<tr>
<th>构建名称</th>
<th>平台</th>
<th>版本</th>
<th>环境</th>
<th>模块</th>
<th>使用方</th>
</tr>
</thead>
<tbody>
<tr>
<td>web-runtime-cjs-dev</td>
<td>web</td>
<td>运行时版</td>
<td>development</td>
<td>CommonJS</td>
<td>Bundlers</td>
</tr>
<tr>
<td>web-runtime-cjs-prod</td>
<td>web</td>
<td>运行时版</td>
<td>production</td>
<td>CommonJS</td>
<td>Bundlers</td>
</tr>
<tr>
<td>web-full-cjs-dev</td>
<td>web</td>
<td>完整版</td>
<td>development</td>
<td>CommonJS</td>
<td>Browser</td>
</tr>
<tr>
<td>web-full-cjs-prod</td>
<td>web</td>
<td>完整版</td>
<td>production</td>
<td>CommonJS</td>
<td>Browser</td>
</tr>
<tr>
<td>web-runtime-esm</td>
<td>web</td>
<td>运行时版本</td>
<td>不区分</td>
<td>ES Module</td>
<td>Bundlers</td>
</tr>
<tr>
<td>web-full-esm</td>
<td>web</td>
<td>完整版</td>
<td>不区分</td>
<td>ES Module</td>
<td>Bundlers</td>
</tr>
<tr>
<td>web-full-esm-browser-dev</td>
<td>web</td>
<td>完整版</td>
<td>development</td>
<td>ES Module</td>
<td>Browser</td>
</tr>
<tr>
<td>web-full-esm-browser-prod</td>
<td>web</td>
<td>完整版</td>
<td>production</td>
<td>ES Module</td>
<td>Browser</td>
</tr>
<tr>
<td>web-runtime-dev</td>
<td>web</td>
<td>运行时版</td>
<td>development</td>
<td>UMD</td>
<td>Browser</td>
</tr>
<tr>
<td>web-runtime-prod</td>
<td>web</td>
<td>运行时版</td>
<td>production</td>
<td>UMD</td>
<td>Browser</td>
</tr>
<tr>
<td>web-full-dev</td>
<td>web</td>
<td>完整版</td>
<td>development</td>
<td>UMD</td>
<td>Browser</td>
</tr>
<tr>
<td>web-full-prod</td>
<td>web</td>
<td>完整版</td>
<td>production</td>
<td>UMD</td>
<td>Browser</td>
</tr>
<tr>
<td>web-compiler</td>
<td>web</td>
<td>编译器</td>
<td>不区分</td>
<td>CommonJS</td>
<td>Bundlers</td>
</tr>
<tr>
<td>web-compiler-browser</td>
<td>web</td>
<td>编译器</td>
<td>development</td>
<td>UMD</td>
<td>Browser</td>
</tr>
<tr>
<td>web-server-renderer-dev</td>
<td>web-server</td>
<td>不区分</td>
<td>development</td>
<td>CommonJS</td>
<td>不区分</td>
</tr>
<tr>
<td>web-server-renderer-prod</td>
<td>web-server</td>
<td>不区分</td>
<td>production</td>
<td>CommonJS</td>
<td>不区分</td>
</tr>
<tr>
<td>web-server-renderer-webpack-server-plugin</td>
<td>web-server</td>
<td>不区分</td>
<td>不区分</td>
<td>CommonJS</td>
<td>Webpack Server</td>
</tr>
<tr>
<td>web-server-renderer-webpack-client-plugin</td>
<td>web-server</td>
<td>不区分</td>
<td>不区分</td>
<td>CommonJS</td>
<td>Webpack Client</td>
</tr>
<tr>
<td>weex-factory</td>
<td>weex</td>
<td>运行时版</td>
<td>不区分</td>
<td>CommonJS</td>
<td>不区分</td>
</tr>
<tr>
<td>weex-framework</td>
<td>weex</td>
<td>运行时版</td>
<td>不区分</td>
<td>CommonJS</td>
<td>不区分</td>
</tr>
<tr>
<td>weex-compiler</td>
<td>weex</td>
<td>编译器</td>
<td>不区分</td>
<td>CommonJS</td>
<td>Weex’s Webpack Loader</td>
</tr>
</tbody>
</table>
<h1 id="package-json"><a href="#package-json" class="headerlink" title="package.json"></a>package.json</h1><p>package.json中的一些字段和构建命令说明如下：</p>
<ul>
<li>main：运行时版本，<code>cjs</code>模块，用于<code>webpack 1</code>或<code>browserify</code></li>
<li>module：运行时版本，<code>es</code>模块，用于<code>webpack 2+</code>或<code>Rollup</code></li>
<li>dev：构建完整版<code>umd</code>模块的Vue</li>
<li>dev:cjs：构建运行时<code>cjs</code>模块的Vue</li>
<li>dev:esm：构建运行时<code>es</code>模块的Vue</li>
<li>dev:ssr：构建<code>web-server-renderer</code>包</li>
<li>dev:compiler：构建<code>Compiler</code>包</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"main"</span>: <span class="string">"dist/vue.runtime.common.js"</span>,</span><br><span class="line">    <span class="attr">"module"</span>: <span class="string">"dist/vue.runtime.esm.js"</span>,</span><br><span class="line">    <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">        <span class="attr">"dev"</span>: <span class="string">"rollup -w -c scripts/config.js --environment TARGET:web-full-dev"</span>,</span><br><span class="line">        <span class="attr">"dev:cjs"</span>: <span class="string">"rollup -w -c scripts/config.js --environment TARGET:web-runtime-cjs-dev"</span>,</span><br><span class="line">        <span class="attr">"dev:esm"</span>: <span class="string">"rollup -w -c scripts/config.js --environment TARGET:web-runtime-esm"</span>,</span><br><span class="line">        <span class="attr">"dev:test"</span>: <span class="string">"karma start test/unit/karma.dev.config.js"</span>,</span><br><span class="line">        <span class="attr">"dev:ssr"</span>: <span class="string">"rollup -w -c scripts/config.js --environment TARGET:web-server-renderer"</span>,</span><br><span class="line">        <span class="attr">"dev:compiler"</span>: <span class="string">"rollup -w -c scripts/config.js --environment TARGET:web-compiler "</span>,</span><br><span class="line">        <span class="attr">"dev:weex"</span>: <span class="string">"rollup -w -c scripts/config.js --environment TARGET:weex-framework"</span>,</span><br><span class="line">        <span class="attr">"dev:weex:factory"</span>: <span class="string">"rollup -w -c scripts/config.js --environment TARGET:weex-factory"</span>,</span><br><span class="line">        <span class="attr">"dev:weex:compiler"</span>: <span class="string">"rollup -w -c scripts/config.js --environment TARGET:weex-compiler "</span>,</span><br><span class="line">        <span class="attr">"build"</span>: <span class="string">"node scripts/build.js"</span>,</span><br><span class="line">        <span class="attr">"build:ssr"</span>: <span class="string">"npm run build -- web-runtime-cjs,web-server-renderer"</span>,</span><br><span class="line">        <span class="attr">"build:weex"</span>: <span class="string">"npm run build -- weex"</span>,</span><br><span class="line">        <span class="attr">"test"</span>: <span class="string">"npm run lint &amp;&amp; flow check &amp;&amp; npm run test:types &amp;&amp; npm run test:cover &amp;&amp; npm run test:e2e -- --env phantomjs &amp;&amp; npm run test:ssr &amp;&amp; npm run test:weex"</span>,</span><br><span class="line">        <span class="attr">"test:unit"</span>: <span class="string">"karma start test/unit/karma.unit.config.js"</span>,</span><br><span class="line">        <span class="attr">"test:cover"</span>: <span class="string">"karma start test/unit/karma.cover.config.js"</span>,</span><br><span class="line">        <span class="attr">"test:e2e"</span>: <span class="string">"npm run build -- web-full-prod,web-server-basic-renderer &amp;&amp; node test/e2e/runner.js"</span>,</span><br><span class="line">        <span class="attr">"test:weex"</span>: <span class="string">"npm run build:weex &amp;&amp; jasmine JASMINE_CONFIG_PATH=test/weex/jasmine.js"</span>,</span><br><span class="line">        <span class="attr">"test:ssr"</span>: <span class="string">"npm run build:ssr &amp;&amp; jasmine JASMINE_CONFIG_PATH=test/ssr/jasmine.js"</span>,</span><br><span class="line">        <span class="attr">"test:sauce"</span>: <span class="string">"npm run sauce -- 0 &amp;&amp; npm run sauce -- 1 &amp;&amp; npm run sauce -- 2"</span>,</span><br><span class="line">        <span class="attr">"test:types"</span>: <span class="string">"tsc -p ./types/test/tsconfig.json"</span>,</span><br><span class="line">        <span class="attr">"lint"</span>: <span class="string">"eslint src scripts test"</span>,</span><br><span class="line">        <span class="attr">"flow"</span>: <span class="string">"flow check"</span>,</span><br><span class="line">        <span class="attr">"sauce"</span>: <span class="string">"karma start test/unit/karma.sauce.config.js"</span>,</span><br><span class="line">        <span class="attr">"bench:ssr"</span>: <span class="string">"npm run build:ssr &amp;&amp; node benchmarks/ssr/renderToString.js &amp;&amp; node benchmarks/ssr/renderToStream.js"</span>,</span><br><span class="line">        <span class="attr">"release"</span>: <span class="string">"bash scripts/release.sh"</span>,</span><br><span class="line">        <span class="attr">"release:weex"</span>: <span class="string">"bash scripts/release-weex.sh"</span>,</span><br><span class="line">        <span class="attr">"release:note"</span>: <span class="string">"node scripts/gen-release-note.js"</span>,</span><br><span class="line">        <span class="attr">"commit"</span>: <span class="string">"git-cz"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下一篇：<a href="/2019/03/20/Vue构造函数.html">Vue构造函数</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/20/通过Vue源码学到的知识.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cong.Wang">
      <meta itemprop="description" content="WgCg、Cong.Wang、WangCong、Vue、Webpack、HTML、CSS、JS">
      <meta itemprop="image" content="/uploads/mine/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WgCg Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/20/通过Vue源码学到的知识.html" class="post-title-link" itemprop="url">通过Vue源码学到的知识</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-20 20:20:35" itemprop="dateCreated datePublished" datetime="2019-03-20T20:20:35+08:00">2019-03-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-27 20:42:59" itemprop="dateModified" datetime="2019-03-27T20:42:59+08:00">2019-03-27</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/" itemprop="url" rel="index"><span itemprop="name">框架</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/Vue/" itemprop="url" rel="index"><span itemprop="name">Vue</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/Vue/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/20/通过Vue源码学到的知识.html#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/20/通过Vue源码学到的知识.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/03/20/通过Vue源码学到的知识.html" class="leancloud_visitors" data-flag-title="通过Vue源码学到的知识">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">1.8k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">2 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><p><code>src/shared/util.js</code>:</p>
 <figure class="highlight javascript"><figcaption><span>camelizeRE</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> camelizeRE = <span class="regexp">/-(\w)/g</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> camelize = cached(</span><br><span class="line">    (str: string): <span class="function"><span class="params">string</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> str.replace(camelizeRE, (_, c) =&gt; (c ? c.toUpperCase() : <span class="string">''</span>))</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p> <code>String.prototype.replace</code>方法第二个参数可以传一个 Callback<code>Function</code>，其返回值将会替换匹配到的字符串</p>
<ul>
<li>如果第一个参数为字符串：Callback 的参数为（第一个匹配到的字符串，匹配到的字符串的起始索引，字符串本身）</li>
<li>如果第一个参数为正则表达式：Callback 的参数为（匹配到的字符串，…所有捕获组，匹配到的字符串的起始索引, 字符串本身）</li>
</ul>
</li>
<li><p><code>src/core/util/options.js</code></p>
 <figure class="highlight javascript"><figcaption><span>validateComponentName</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">validateComponentName</span>(<span class="params">name: string</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`^[a-zA-Z][\\-\\.0-9_<span class="subst">$&#123;unicodeLetters&#125;</span>]*$`</span>).test(name)) &#123;</span><br><span class="line">        warn(<span class="string">'Invalid component name: "'</span> + name + <span class="string">'". Component names '</span> + <span class="string">'should conform to valid custom element name in html5 specification.'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isBuiltInTag(name) || config.isReservedTag(name)) &#123;</span><br><span class="line">        warn(<span class="string">'Do not use built-in or reserved HTML elements as component '</span> + <span class="string">'id: '</span> + name)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>声明一个字符串时如果字符串中包含单<code>\</code>，实际上会被去除，<code>\\</code>的意思才表示<code>\</code></li>
<li>声明正则表达式时包含单<code>\</code>，会报错</li>
<li><p>正则表达式定义范围时<code>[]</code>，里面的类似于<code>*.</code>等字符不进行转义处理与进行转义处理的效果是一致的，而<code>\w</code>必须进行转义处理</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// abcd\</span></span><br><span class="line"><span class="keyword">let</span> a = <span class="string">'\abcd\\'</span></span><br><span class="line"><span class="comment">// error</span></span><br><span class="line"><span class="keyword">let</span> reg = <span class="regexp">/abcde\/</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ reg1的效果与reg2的效果一致</span></span><br><span class="line"><span class="regexp">let reg1 = /</span>[.*]/</span><br><span class="line"><span class="keyword">let</span> reg1 = <span class="regexp">/[\.\*]/</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>调用<code>Object.defineProperty</code>时，只设置<code>get</code>不设置<code>set</code>，则其相当于<code>readonly</code></p>
</li>
<li><p>window.performance的运用，在<code>Chrome devtool</code>中的<code>Performance -&gt; Timing</code>中可以看到性能记录信息</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> perf = <span class="built_in">window</span>.performance</span><br><span class="line"><span class="keyword">const</span> startTag = <span class="string">'perf-start'</span></span><br><span class="line"><span class="keyword">const</span> endTag = <span class="string">'perf-end'</span></span><br><span class="line"></span><br><span class="line">perf &amp;&amp; perf.mark(startTag)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (perf) &#123;</span><br><span class="line">    perf.mark(endTag)</span><br><span class="line">    perf.measure(<span class="string">'performance test'</span>, startTag, endTag)</span><br><span class="line">    <span class="built_in">console</span>.log(perf.getEntries())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Object.keys</code>与<code>Reflect.ownKeys</code>都是遍历对象自身的属性，但是<code>Object.keys</code>无法遍历出<code>Symbol</code>属性且受<code>enumerable</code>影响，而<code>Reflect.ownKeys</code>可以遍历出<code>Sumbol</code>属性且不受<code>enumerable</code>影响</p>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/20/Vue构造函数.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cong.Wang">
      <meta itemprop="description" content="WgCg、Cong.Wang、WangCong、Vue、Webpack、HTML、CSS、JS">
      <meta itemprop="image" content="/uploads/mine/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WgCg Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/20/Vue构造函数.html" class="post-title-link" itemprop="url">Vue构造函数</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-20 20:19:50" itemprop="dateCreated datePublished" datetime="2019-03-20T20:19:50+08:00">2019-03-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-03-26 11:23:54" itemprop="dateModified" datetime="2019-03-26T11:23:54+08:00">2019-03-26</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/" itemprop="url" rel="index"><span itemprop="name">框架</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/Vue/" itemprop="url" rel="index"><span itemprop="name">Vue</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/框架/Vue/原理/" itemprop="url" rel="index"><span itemprop="name">原理</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/20/Vue构造函数.html#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/20/Vue构造函数.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/03/20/Vue构造函数.html" class="leancloud_visitors" data-flag-title="Vue构造函数">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">9.2k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">8 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Vue构造函数的原型"><a href="#Vue构造函数的原型" class="headerlink" title="Vue构造函数的原型"></a>Vue构造函数的原型</h1><p>以<code>npm run dev</code>为切入点，查看<code>package.json</code>中的<code>dev script</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"dev"</span>: <span class="string">"rollup -w -c scripts/config.js --environment TARGET:web-full-dev"</span></span><br></pre></td></tr></table></figure>
<p>找到scripts下的config.js，builds对象中包含了不同的构建配置，具体有哪些配置以及它们之间有什么不同请阅读<a href="/2019/03/20/了解Vue这个项目.html">了解Vue这个项目</a>，查找构建目标<code>web-full-dev</code>对应的配置，其对应的入口文件为<code>web/entry-runtime-with-compiler.js</code>，<code>web</code>所指向的目录在路径别名配置文件<code>scripts/alias.js</code>中，其指向的是<code>src/platforms/web</code>目录</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> builds = &#123;</span><br><span class="line">  <span class="comment">// Runtime+compiler development build (Browser)</span></span><br><span class="line">  <span class="string">'web-full-dev'</span>: &#123;</span><br><span class="line">    entry: resolve(<span class="string">'web/entry-runtime-with-compiler.js'</span>),</span><br><span class="line">    dest: resolve(<span class="string">'dist/vue.js'</span>),</span><br><span class="line">    format: <span class="string">'umd'</span>,</span><br><span class="line">    env: <span class="string">'development'</span>,</span><br><span class="line">    alias: &#123; <span class="attr">he</span>: <span class="string">'./entity-decoder'</span> &#125;,</span><br><span class="line">    banner</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>打开<code>src/platforms/web/entry-runtime-with-compiler.js</code>目录，有这么一句<code>import Vue from &#39;./runtime/index&#39;</code>，依次向上查找到声明Vue的文件为<code>src/core/instance/index.js</code>，查找路径为下：</p>
<ol>
<li>src/platforms/web/entry-runtime-with-compiler.js：import Vue from ‘./runtime/index’</li>
<li>src/platforms/web/runtime/index.js：import Vue from ‘core/index’（core指的是src/core，请查看别名文件<code>scripts/alias.js</code>）</li>
<li>src/core/index.js：import Vue from ‘./instance/index’</li>
<li>src/core/instance/index.js：End</li>
</ol>
<p><code>src/core/instance/index.js</code>文件的内容如下图，其中所调用的各个方法的作用为：</p>
<figure class="highlight javascript"><figcaption><span>src/core/instance/index.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; initMixin &#125; <span class="keyword">from</span> <span class="string">'./init'</span></span><br><span class="line"><span class="keyword">import</span> &#123; stateMixin &#125; <span class="keyword">from</span> <span class="string">'./state'</span></span><br><span class="line"><span class="keyword">import</span> &#123; renderMixin &#125; <span class="keyword">from</span> <span class="string">'./render'</span></span><br><span class="line"><span class="keyword">import</span> &#123; eventsMixin &#125; <span class="keyword">from</span> <span class="string">'./events'</span></span><br><span class="line"><span class="keyword">import</span> &#123; lifecycleMixin &#125; <span class="keyword">from</span> <span class="string">'./lifecycle'</span></span><br><span class="line"><span class="keyword">import</span> &#123; warn &#125; <span class="keyword">from</span> <span class="string">'../util/index'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">    !(<span class="keyword">this</span> <span class="keyword">instanceof</span> Vue)</span><br><span class="line">  ) &#123;</span><br><span class="line">    warn(<span class="string">'Vue is a constructor and should be called with the `new` keyword'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>._init(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">initMixin(Vue)</span><br><span class="line">stateMixin(Vue)</span><br><span class="line">eventsMixin(Vue)</span><br><span class="line">lifecycleMixin(Vue)</span><br><span class="line">renderMixin(Vue)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Vue</span><br></pre></td></tr></table></figure>
<ol>
<li><p>initMixin</p>
<ol>
<li>定义了方法：Vue.prototype._init，该方法是内部初始化的一个方法，在Vue构造函数中被调用</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initMixin</span> (<span class="params">Vue: Class&lt;Component&gt;</span>) </span>&#123;</span><br><span class="line">    Vue.prototype._init = <span class="function"><span class="keyword">function</span> (<span class="params">options?: Object</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// ... _init 方法的函数体，此处省略</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>stateMixin</p>
<ol>
<li><p>定义了属性：Vue.prototype.$data代理了Vue实例的_data属性，Vue.prototype.$props代理了Vue实例的_props属性，在非生产环境修改_data和_props会给予错误提示，<a href="https://cn.vuejs.org/v2/api/index.html#vm-data" target="_blank" rel="noopener">属性介绍</a></p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dataDef = &#123;&#125;</span><br><span class="line">dataDef.get = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>._data &#125;</span><br><span class="line"><span class="keyword">const</span> propsDef = &#123;&#125;</span><br><span class="line">propsDef.get = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>._props &#125;</span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    dataDef.set = <span class="function"><span class="keyword">function</span> (<span class="params">newData: Object</span>) </span>&#123;</span><br><span class="line">    warn(</span><br><span class="line">        <span class="string">'Avoid replacing instance root $data. '</span> +</span><br><span class="line">        <span class="string">'Use nested data properties instead.'</span>,</span><br><span class="line">        <span class="keyword">this</span></span><br><span class="line">    )</span><br><span class="line">    &#125;</span><br><span class="line">    propsDef.set = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    warn(<span class="string">`$props is readonly.`</span>, <span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(Vue.prototype, <span class="string">'$data'</span>, dataDef)</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(Vue.prototype, <span class="string">'$props'</span>, propsDef)</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义了方法：Vue.prototype.$set，Vue.prototype.$delete，Vue.prototype.$watch，<a href="https://cn.vuejs.org/v2/api/index.html#vm-watch" target="_blank" rel="noopener">方法介绍</a></p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype.$set = set</span><br><span class="line">Vue.prototype.$<span class="keyword">delete</span> = del</span><br><span class="line"></span><br><span class="line">Vue.prototype.$watch = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    expOrFn: string | Function,</span></span></span><br><span class="line"><span class="function"><span class="params">    cb: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    options?: Object</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>eventsMixin</p>
<ol>
<li><p>定义了方法：Vue.prototype.$on，Vue.prototype.$once，Vue.prototype.$off，Vue.prototype.$emmit，<a href="https://cn.vuejs.org/v2/api/index.html#vm-on" target="_blank" rel="noopener">方法介绍</a></p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype.$on = <span class="function"><span class="keyword">function</span> (<span class="params">event: string | Array&lt;string&gt;, fn: Function</span>): <span class="title">Component</span> </span>&#123;&#125;</span><br><span class="line">Vue.prototype.$once = <span class="function"><span class="keyword">function</span> (<span class="params">event: string, fn: Function</span>): <span class="title">Component</span> </span>&#123;&#125;</span><br><span class="line">Vue.prototype.$off = <span class="function"><span class="keyword">function</span> (<span class="params">event?: string | Array&lt;string&gt;, fn?: Function</span>): <span class="title">Component</span> </span>&#123;&#125;</span><br><span class="line">Vue.prototype.$emit = <span class="function"><span class="keyword">function</span> (<span class="params">event: string</span>): <span class="title">Component</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>lifecycleMixin</p>
<ol>
<li><p>定义了方法：Vue.prototype._update（内部使用），Vue.prototype.$forceUpdate，Vue.prototype.$destory，<a href="https://cn.vuejs.org/v2/api/index.html#vm-forceUpdate" target="_blank" rel="noopener">方法介绍</a></p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype._update = <span class="function"><span class="keyword">function</span> (<span class="params">vnode: VNode, hydrating?: boolean</span>) </span>&#123;&#125;</span><br><span class="line">Vue.prototype.$forceUpdate = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">Vue.prototype.$destroy = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>renderMixin</p>
<ol>
<li><p>以Vue.prototype为参数调用了<code>src/core/instance/render-helpers/index.js</code>中的<code>installRenderHelpers</code>方法</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">installRenderHelpers</span> (<span class="params">target: any</span>) </span>&#123;</span><br><span class="line">    target._o = markOnce</span><br><span class="line">    target._n = toNumber</span><br><span class="line">    target._s = toString</span><br><span class="line">    target._l = renderList</span><br><span class="line">    target._t = renderSlot</span><br><span class="line">    target._q = looseEqual</span><br><span class="line">    target._i = looseIndexOf</span><br><span class="line">    target._m = renderStatic</span><br><span class="line">    target._f = resolveFilter</span><br><span class="line">    target._k = checkKeyCodes</span><br><span class="line">    target._b = bindObjectProps</span><br><span class="line">    target._v = createTextVNode</span><br><span class="line">    target._e = createEmptyVNode</span><br><span class="line">    target._u = resolveScopedSlots</span><br><span class="line">    target._g = bindObjectListeners</span><br><span class="line">    target._d = bindDynamicKeys</span><br><span class="line">    target._p = prependModifier</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义了方法：Vue.prototype.$nextTick、Vue.prototype._render（内部使用），<a href="https://cn.vuejs.org/v2/api/index.html#vm-nextTick" target="_blank" rel="noopener">方法介绍</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype.$nextTick = <span class="function"><span class="keyword">function</span> (<span class="params">fn: Function</span>) </span>&#123;&#125;</span><br><span class="line">Vue.prototype._render = <span class="function"><span class="keyword">function</span> (<span class="params"></span>): <span class="title">VNode</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ol>
<h1 id="Vue-构造函数的静态属性和方法（全局API）"><a href="#Vue-构造函数的静态属性和方法（全局API）" class="headerlink" title="Vue 构造函数的静态属性和方法（全局API）"></a>Vue 构造函数的静态属性和方法（全局API）</h1><p>按照查找Vue构造函数时的文件路径回溯，打开<code>src/core/index.js</code>文件，其内容如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'./instance/index'</span></span><br><span class="line"><span class="keyword">import</span> &#123; initGlobalAPI &#125; <span class="keyword">from</span> <span class="string">'./global-api/index'</span></span><br><span class="line"><span class="keyword">import</span> &#123; isServerRendering &#125; <span class="keyword">from</span> <span class="string">'core/util/env'</span></span><br><span class="line"><span class="keyword">import</span> &#123; FunctionalRenderContext &#125; <span class="keyword">from</span> <span class="string">'core/vdom/create-functional-component'</span></span><br><span class="line"></span><br><span class="line">initGlobalAPI(Vue)</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(Vue.prototype, <span class="string">'$isServer'</span>, &#123;</span><br><span class="line">  get: isServerRendering</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(Vue.prototype, <span class="string">'$ssrContext'</span>, &#123;</span><br><span class="line">  get () &#123;</span><br><span class="line">    <span class="comment">/* istanbul ignore next */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$vnode &amp;&amp; <span class="keyword">this</span>.$vnode.ssrContext</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// expose FunctionalRenderContext for ssr runtime helper installation</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(Vue, <span class="string">'FunctionalRenderContext'</span>, &#123;</span><br><span class="line">  value: FunctionalRenderContext</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">Vue.version = <span class="string">'__VERSION__'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Vue</span><br></pre></td></tr></table></figure>
<ol>
<li><p>调用<code>src/core/global-api/index.js</code>中的<code>initGlobalAPI</code>方法</p>
<ol>
<li><p>定义了属性Vue.config，代理了<code>src/core/config.js</code>导出的对象，并且在非生产环境修改时给予错误提示。<a href="https://cn.vuejs.org/v2/api/index.html#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener">属性介绍</a></p>
  <figure class="highlight javascript"><figcaption><span>src/core/config.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (&#123;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Option merge strategies (used in core/util/options)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">optionMergeStrategies: <span class="built_in">Object</span>.create(<span class="literal">null</span>),</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Whether to suppress warnings.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">silent: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Show production mode tip message on boot?</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">productionTip: process.env.NODE_ENV !== <span class="string">'production'</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Whether to enable devtools</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">devtools: process.env.NODE_ENV !== <span class="string">'production'</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Whether to record perf</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">performance: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Error handler for watcher errors</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">errorHandler: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Warn handler for watcher warns</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">warnHandler: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Ignore certain custom elements</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">ignoredElements: [],</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Custom user key aliases for v-on</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// $flow-disable-line</span></span><br><span class="line">keyCodes: <span class="built_in">Object</span>.create(<span class="literal">null</span>),</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Check if a tag is reserved so that it cannot be registered as a</span></span><br><span class="line"><span class="comment">* component. This is platform-dependent and may be overwritten.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">isReservedTag: no,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Check if an attribute is reserved so that it cannot be used as a component</span></span><br><span class="line"><span class="comment">* prop. This is platform-dependent and may be overwritten.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">isReservedAttr: no,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Check if a tag is an unknown element.</span></span><br><span class="line"><span class="comment">* Platform-dependent.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">isUnknownElement: no,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Get the namespace of an element</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">getTagNamespace: noop,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Parse the real tag name for the specific platform.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">parsePlatformTagName: identity,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Check if an attribute must be bound using property, e.g. value</span></span><br><span class="line"><span class="comment">* Platform-dependent.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">mustUseProp: no,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Perform updates asynchronously. Intended to be used by Vue Test Utils</span></span><br><span class="line"><span class="comment">* This will significantly reduce performance if set to false.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">async</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Exposed for legacy reasons</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">_lifecycleHooks: LIFECYCLE_HOOKS</span><br><span class="line">&#125;: Config)</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义了Vue.util，该对象下有4个属性：warn、extend、mergeOptions、defineReactive。这4个属性来自<code>src/core/util/index.js</code>。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// exposed util methods.</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> these are not considered part of the public API - avoid relying on</span></span><br><span class="line"><span class="comment">// them unless you are aware of the risk.</span></span><br><span class="line">Vue.util = &#123;</span><br><span class="line">    warn,</span><br><span class="line">    extend,</span><br><span class="line">    mergeOptions,</span><br><span class="line">    defineReactive</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  这里有一段注释，大概意思是 Vue.util 以及 util 下的四个方法都不被认为是公共API的一部分，要避免依赖他们，但是你依然可以使用，只不过风险你要自己控制。并且，在官方文档上也并没有介绍这个全局API，所以能不用尽量不要用。</p>
</li>
<li><p>定义了Vue.set、Vue.delete、Vue.nextTick、Vue.observable、Vue.options，<a href="https://cn.vuejs.org/v2/api/index.html#%E5%85%A8%E5%B1%80-API" target="_blank" rel="noopener">属性介绍</a></p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Vue.set = set</span><br><span class="line">Vue.delete = del</span><br><span class="line">Vue.nextTick = nextTick</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.6 explicit observable API</span></span><br><span class="line">Vue.observable = <span class="xml"><span class="tag">&lt;<span class="name">T</span>&gt;</span>(obj: T): T =&gt; &#123;</span></span><br><span class="line"><span class="xml">    observe(obj)</span></span><br><span class="line"><span class="xml">    return obj</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">Vue.options = &#123;</span></span><br><span class="line"><span class="xml">    components: &#123;</span></span><br><span class="line"><span class="xml">        KeepAlive</span></span><br><span class="line"><span class="xml">    &#125;,</span></span><br><span class="line"><span class="xml">    directives: Object.create(null),</span></span><br><span class="line"><span class="xml">    filters: Object.create(null),</span></span><br><span class="line"><span class="xml">    _base: Vue</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>调用了以下方法，<a href="https://cn.vuejs.org/v2/api/index.html#%E5%85%A8%E5%B1%80-API" target="_blank" rel="noopener">全局API介绍</a></p>
<ol>
<li>initUse：定义了Vue.use</li>
<li>initMixin：定义了Vue.mixin</li>
<li>initExtend：定义了Vue.cid、Vue.extend</li>
<li>initAssetRegisters：定义了Vue.compontent、Vue.directive、Vue.filter</li>
</ol>
</li>
</ol>
</li>
<li>定义了Vue.$isServer、Vue.$ssrContext、Vue.version（<strong>VERSION</strong>在<code>scripts/config.js</code>中定义）</li>
</ol>
<h1 id="Vue-平台化的包装"><a href="#Vue-平台化的包装" class="headerlink" title="Vue 平台化的包装"></a>Vue 平台化的包装</h1><p>这节主要说了几件事</p>
<ol>
<li><code>src/core</code>目录下存放的是与平台无关的代码</li>
<li><code>src/platforms</code>下的目录作用是针对<code>web</code>和<code>weex</code>平台进行不同的包装，例如Vue.config（代理的是<code>core/config.js</code>导出的对象，上文有说到）的默认属性，因平台的不同，其属性会被覆盖，例如：<code>src/platforms/runtime/index.js</code>中干了几件事：<ol>
<li>设置平台化的<code>Vue.config</code></li>
<li>在<code>Vue.options</code>中混合了两个指令（<code>directives</code>），分别是<code>model</code>和<code>show</code></li>
<li>在<code>Vue.options</code>中混合了两个组件（<code>components</code>），分别是<code>Transition</code>和<code>TransitionGroup</code></li>
<li>在<code>Vue.prototype</code>上添加了两个方法：<code>__patch</code>和<code>$mount</code></li>
</ol>
</li>
</ol>
<h2 id="with-compiler"><a href="#with-compiler" class="headerlink" title="with compiler"></a>with compiler</h2><ol>
<li><code>运行时版</code>的入口文件<code>src/platforms/web/entry-runtime.js</code>导出的<code>Vue</code>就到<code>./runtime/index.js</code>为止，Vue构造函数和原型包含的属性和方法就是上面所有的内容</li>
<li><code>完整版</code>导出的<code>Vue</code>在运行时版上多了个<code>compiler</code>，具体查看<code>src/platforms/web/entry-runtime-with-compiler.js</code>，这个文件对<code>Vue</code>的影响有两个：<ol>
<li>重写了Vue.prototype.$mount的方法</li>
<li>增加了Vue.compile全局API</li>
</ol>
</li>
</ol>
<p>下一篇：<a href="/2019/03/21/以一个例子为线索.html">以一个例子为线索</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/19/vscode-typescript问题记录.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cong.Wang">
      <meta itemprop="description" content="WgCg、Cong.Wang、WangCong、Vue、Webpack、HTML、CSS、JS">
      <meta itemprop="image" content="/uploads/mine/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WgCg Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/19/vscode-typescript问题记录.html" class="post-title-link" itemprop="url">vscode+typescript问题记录</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-19 21:14:55 / 修改时间：21:52:50" itemprop="dateCreated datePublished" datetime="2019-03-19T21:14:55+08:00">2019-03-19</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/编程语言/" itemprop="url" rel="index"><span itemprop="name">编程语言</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/编程语言/typescript/" itemprop="url" rel="index"><span itemprop="name">typescript</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/编程语言/typescript/问题积累/" itemprop="url" rel="index"><span itemprop="name">问题积累</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/19/vscode-typescript问题记录.html#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/19/vscode-typescript问题记录.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/03/19/vscode-typescript问题记录.html" class="leancloud_visitors" data-flag-title="vscode+typescript问题记录">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">89</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">1 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ESLint"><a href="#ESLint" class="headerlink" title="ESLint"></a>ESLint</h1><h2 id="VSCode的ESLint扩展支持-ts-tsx文件"><a href="#VSCode的ESLint扩展支持-ts-tsx文件" class="headerlink" title="VSCode的ESLint扩展支持.ts,.tsx文件"></a>VSCode的ESLint扩展支持.ts,.tsx文件</h2><p>command+shift+p调出命令面板，选择Open Settings(JSON)，在配置中加入以下内容</p>
<p><img width="500" src="/assets/typescript/problems/5.jpg" title="settings.json" alt="settings.json"></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/mine/head.jpg" alt="Cong.Wang">
            
              <p class="site-author-name" itemprop="name">Cong.Wang</p>
              <p class="site-description motion-element" itemprop="description">WgCg、Cong.Wang、WangCong、Vue、Webpack、HTML、CSS、JS</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">36</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">24</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">36</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cong.Wang</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">210k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">3:11</span>
  
</div>









        








        
      </div>
    </footer>

    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  



  
    
    
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.7.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.7.0"></script>



  

  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  

  
    <script id="dsq-count-scr" src="https://aaaa.disqus.com/count.js" async></script>
  

  













  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script>
    
    function showTime(Counter) {
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url: { "$in": entries } }) })
        .done(function ({ results }) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.url;
            var time = item.time;
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function ({ responseJSON }) {
          console.log("LeanCloud Counter Error: " + responseJSON.code + " " + responseJSON.error);
        });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + "Snnrz3T8cyFAvfrigABOEySh-gzGzoHsz")
        .done(function ({ api_server }) {
          var Counter = function (method, url, data) {
            return $.ajax({
              method: method,
              url: `https://${api_server}/1.1${url}`,
              headers: {
                'X-LC-Id': "Snnrz3T8cyFAvfrigABOEySh-gzGzoHsz",
                'X-LC-Key': "fvRMLVR3k87Xglv5rclYX1mu",
                'Content-Type': 'application/json',
              },
              data: data,
            });
          };
          
          if ($('.post-title-link').length >= 1) {
            showTime(Counter);
          }
          
        })
    });
  </script>



  

  

  

  

  
  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>
  <script>
    
      pbOptions = {};
      
        pbOptions.iconStyle = "box";
      
        pbOptions.boxForm = "horizontal";
      
        pbOptions.position = "bottomCenter";
      
        pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
  </script>


  

  

  

  

  

  

  


  
<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":100,"height":200},"mobile":{"show":false},"log":false});</script></body>
</html>
